substitutions:
  # Device info
  device_name: "plugs-controller"
  friendly_name: "Kauf Plugs Controller"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_size: 8MB
    board_build.flash_mode: dio

esp32:
  board: esp32-s3-devkitc-1
  variant: ESP32S3
  flash_size: 8MB
  framework:
    type: esp-idf

# Enable logging
logger:
  level: INFO

# Enable Home Assistant API
api:
  reboot_timeout: 0s
  encryption:
    key: "+6lkh+FkWq3HVFh6+NukfmN188wGMQap7sw2RK1p9Gg="

# OTA updates
ota:
  - platform: esphome
    password: "48170f28ed94e6fe392d67906b01ff74"

# WiFi configuration
wifi:
  ssid: "JEREMY"
  password: "605506Jdb"
  power_save_mode: NONE
  reboot_timeout: 0s

  # Fallback hotspot
  ap:
    ssid: "${friendly_name} Hotspot"
    password: "12345678"

# Web server for UI at plugs.local
web_server:
  port: 80
  version: 2
  local: true
  ota: false

# mDNS for plugs.local
mdns:
  disabled: false

# Captive portal
captive_portal:

# Web server base
web_server_base:
  id: web_server_base_id

# Custom component for Waveshare UI
custom_component:
  - lambda: |-
      static const char WAVESHARE_UI_HTML[] PROGMEM = R"rawliteral(
      <!DOCTYPE html>
      <html>
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Smart-Home Controller</title>
          <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                  font-family: Arial, sans-serif;
                  background: linear-gradient(180deg, #0A1929 0%, #0F2847 100%);
                  color: white;
                  min-height: 100vh;
                  padding: 10px;
              }
              .page { display: none; max-width: 800px; margin: 0 auto; }
              .page.active { display: block; }
              .header {
                  background: linear-gradient(180deg, #1E3A5F 0%, #0F2847 100%);
                  padding: 15px;
                  text-align: center;
                  border-radius: 8px;
                  margin-bottom: 20px;
              }
              .header h1 { font-size: 24px; font-weight: normal; }
              .plug-grid {
                  display: grid;
                  grid-template-columns: repeat(2, 1fr);
                  gap: 20px;
                  padding: 20px;
              }
              .plug-row { display: flex; gap: 10px; align-items: center; }
              .plug-btn {
                  flex: 2;
                  height: 60px;
                  border: none;
                  border-radius: 8px;
                  font-size: 16px;
                  font-weight: bold;
                  color: white;
                  cursor: pointer;
                  transition: all 0.3s;
                  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
              }
              .plug-btn.off {
                  background: linear-gradient(135deg, #FF0000 0%, #CC0000 100%);
              }
              .plug-btn.on {
                  background: linear-gradient(135deg, #00FF00 0%, #00CC00 100%);
              }
              .plug-btn:active { transform: scale(0.98); }
              .timer-btn {
                  flex: 1;
                  height: 60px;
                  background: linear-gradient(135deg, #444444 0%, #333333 100%);
                  border: none;
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  cursor: pointer;
                  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
              }
              .timer-btn:active { transform: scale(0.98); }
              .timer-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding: 20px;
                  background: rgba(30, 58, 95, 0.5);
                  border-radius: 8px;
                  margin-bottom: 20px;
              }
              .timer-title h2 { font-size: 22px; margin-bottom: 5px; }
              .timer-title .ip { color: #00FF00; font-size: 14px; }
              .back-btn {
                  padding: 15px 30px;
                  background: #333333;
                  border: none;
                  border-radius: 8px;
                  color: white;
                  font-size: 16px;
                  cursor: pointer;
                  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
              }
              .back-btn:active { transform: scale(0.98); }
              .timer-controls { padding: 20px; }
              .timer-toggle {
                  width: 100%;
                  padding: 20px;
                  background: #555555;
                  border: none;
                  border-radius: 8px;
                  color: white;
                  font-size: 18px;
                  cursor: pointer;
                  margin-bottom: 30px;
                  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
              }
              .timer-toggle.enabled {
                  background: linear-gradient(135deg, #228B22 0%, #1a6b1a 100%);
              }
              .time-section { margin-bottom: 30px; }
              .time-label {
                  font-size: 18px;
                  margin-bottom: 15px;
                  padding-left: 5px;
              }
              .time-controls { display: flex; gap: 10px; flex-wrap: wrap; }
              .time-btn {
                  padding: 15px 20px;
                  background: #444444;
                  border: none;
                  border-radius: 8px;
                  color: white;
                  font-size: 16px;
                  cursor: pointer;
                  min-width: 80px;
                  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
              }
              .time-btn:active { transform: scale(0.98); }
              @media (max-width: 600px) {
                  .plug-grid { grid-template-columns: 1fr; }
                  .header h1 { font-size: 20px; }
                  .time-controls { justify-content: center; }
              }
          </style>
      </head>
      <body>
          <div id="mainPage" class="page active">
              <div class="header">
                  <h1>Smart-Home Controller</h1>
              </div>
              <div class="plug-grid">
                  <div class="plug-row">
                      <button id="plug1Btn" class="plug-btn off" onclick="togglePlug(1)">PLUG 1</button>
                      <button class="timer-btn" onclick="showTimerPage(1)">Timer</button>
                  </div>
                  <div class="plug-row">
                      <button id="plug5Btn" class="plug-btn off" onclick="togglePlug(5)">PLUG 5</button>
                      <button class="timer-btn" onclick="showTimerPage(5)">Timer</button>
                  </div>
                  <div class="plug-row">
                      <button id="plug2Btn" class="plug-btn off" onclick="togglePlug(2)">PLUG 2</button>
                      <button class="timer-btn" onclick="showTimerPage(2)">Timer</button>
                  </div>
                  <div class="plug-row">
                      <button id="plug6Btn" class="plug-btn off" onclick="togglePlug(6)">PLUG 6</button>
                      <button class="timer-btn" onclick="showTimerPage(6)">Timer</button>
                  </div>
                  <div class="plug-row">
                      <button id="plug3Btn" class="plug-btn off" onclick="togglePlug(3)">PLUG 3</button>
                      <button class="timer-btn" onclick="showTimerPage(3)">Timer</button>
                  </div>
                  <div class="plug-row">
                      <button id="plug7Btn" class="plug-btn off" onclick="togglePlug(7)">PLUG 7</button>
                      <button class="timer-btn" onclick="showTimerPage(7)">Timer</button>
                  </div>
                  <div class="plug-row">
                      <button id="plug4Btn" class="plug-btn off" onclick="togglePlug(4)">PLUG 4</button>
                      <button class="timer-btn" onclick="showTimerPage(4)">Timer</button>
                  </div>
                  <div class="plug-row">
                      <button id="plug8Btn" class="plug-btn off" onclick="togglePlug(8)">PLUG 8</button>
                      <button class="timer-btn" onclick="showTimerPage(8)">Timer</button>
                  </div>
              </div>
          </div>
          <div id="timerPage1" class="page">
              <div class="timer-header">
                  <div class="timer-title">
                      <h2 id="timer1Title">PLUG 1 TIMER</h2>
                      <div class="ip" id="timer1IP">IP: Loading...</div>
                  </div>
                  <button class="back-btn" onclick="showMainPage()">BACK</button>
              </div>
              <div class="timer-controls">
                  <button id="timer1Toggle" class="timer-toggle" onclick="toggleTimer(1)">Timer: OFF</button>
                  <div class="time-section">
                      <div class="time-label" id="timer1OnTime">ON: 08:00 AM</div>
                      <div class="time-controls">
                          <button class="time-btn" onclick="adjustTime(1, 'on', 'hour', -1)">H-</button>
                          <button class="time-btn" onclick="adjustTime(1, 'on', 'hour', 1)">H+</button>
                          <button class="time-btn" onclick="adjustTime(1, 'on', 'minute', -1)">M-</button>
                          <button class="time-btn" onclick="adjustTime(1, 'on', 'minute', 1)">M+</button>
                          <button class="time-btn" onclick="toggleAMPM(1, 'on')">AM/PM</button>
                      </div>
                  </div>
                  <div class="time-section">
                      <div class="time-label" id="timer1OffTime">OFF: 06:00 PM</div>
                      <div class="time-controls">
                          <button class="time-btn" onclick="adjustTime(1, 'off', 'hour', -1)">H-</button>
                          <button class="time-btn" onclick="adjustTime(1, 'off', 'hour', 1)">H+</button>
                          <button class="time-btn" onclick="adjustTime(1, 'off', 'minute', -1)">M-</button>
                          <button class="time-btn" onclick="adjustTime(1, 'off', 'minute', 1)">M+</button>
                          <button class="time-btn" onclick="toggleAMPM(1, 'off')">AM/PM</button>
                      </div>
                  </div>
              </div>
          </div>
          <script>
              for (let i = 2; i <= 8; i++) {
                  const page1 = document.getElementById('timerPage1');
                  const newPage = page1.cloneNode(true);
                  newPage.id = `timerPage${i}`;
                  newPage.querySelector('h2').id = `timer${i}Title`;
                  newPage.querySelector('.ip').id = `timer${i}IP`;
                  newPage.querySelector('.timer-toggle').id = `timer${i}Toggle`;
                  newPage.querySelector('.timer-toggle').setAttribute('onclick', `toggleTimer(${i})`);
                  newPage.querySelectorAll('.time-label')[0].id = `timer${i}OnTime`;
                  newPage.querySelectorAll('.time-label')[1].id = `timer${i}OffTime`;
                  const timeButtons = newPage.querySelectorAll('.time-btn');
                  timeButtons[0].setAttribute('onclick', `adjustTime(${i}, 'on', 'hour', -1)`);
                  timeButtons[1].setAttribute('onclick', `adjustTime(${i}, 'on', 'hour', 1)`);
                  timeButtons[2].setAttribute('onclick', `adjustTime(${i}, 'on', 'minute', -1)`);
                  timeButtons[3].setAttribute('onclick', `adjustTime(${i}, 'on', 'minute', 1)`);
                  timeButtons[4].setAttribute('onclick', `toggleAMPM(${i}, 'on')`);
                  timeButtons[5].setAttribute('onclick', `adjustTime(${i}, 'off', 'hour', -1)`);
                  timeButtons[6].setAttribute('onclick', `adjustTime(${i}, 'off', 'hour', 1)`);
                  timeButtons[7].setAttribute('onclick', `adjustTime(${i}, 'off', 'minute', -1)`);
                  timeButtons[8].setAttribute('onclick', `adjustTime(${i}, 'off', 'minute', 1)`);
                  timeButtons[9].setAttribute('onclick', `toggleAMPM(${i}, 'off')`);
                  document.body.appendChild(newPage);
              }
              const plugStates = {};
              const timerStates = {};
              let numPlugsActive = 8;  // Default to 8, will be updated from server

              for (let i = 1; i <= 8; i++) {
                  plugStates[i] = { name: `PLUG ${i}`, ip: '', state: false };
                  timerStates[i] = { enabled: false, onHour: 8, onMinute: 0, onAMPM: 'AM', offHour: 6, offMinute: 0, offAMPM: 'PM' };
              }
              function updateVisiblePlugs() {
                  // Show/hide plug rows based on numPlugsActive
                  const plugButtons = ['plug1Btn', 'plug2Btn', 'plug3Btn', 'plug4Btn', 'plug5Btn', 'plug6Btn', 'plug7Btn', 'plug8Btn'];
                  plugButtons.forEach((id, index) => {
                      const plugNum = index + 1;
                      const row = document.getElementById(id).parentElement;
                      if (plugNum <= numPlugsActive) {
                          row.style.display = 'flex';
                      } else {
                          row.style.display = 'none';
                      }
                  });
              }

              function showMainPage() {
                  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                  document.getElementById('mainPage').classList.add('active');
                  updateVisiblePlugs();
              }
              function showTimerPage(plugNum) {
                  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                  document.getElementById(`timerPage${plugNum}`).classList.add('active');
                  updateTimerDisplay(plugNum);
              }
              async function togglePlug(plugNum) {
                  const btn = document.getElementById(`plug${plugNum}Btn`);
                  btn.disabled = true;
                  try {
                      const action = plugStates[plugNum].state ? 'turn_off' : 'turn_on';
                      await fetch(`/button/plug${plugNum}_${action}/press`, { method: 'POST' });
                      plugStates[plugNum].state = !plugStates[plugNum].state;
                      updatePlugButton(plugNum);
                      setTimeout(() => updatePlugStates(), 500);
                  } catch (error) {
                      console.error('Error toggling plug:', error);
                  } finally {
                      btn.disabled = false;
                  }
              }
              function updatePlugButton(plugNum) {
                  const btn = document.getElementById(`plug${plugNum}Btn`);
                  const state = plugStates[plugNum];
                  btn.textContent = state.name;
                  btn.className = `plug-btn ${state.state ? 'on' : 'off'}`;
              }
              async function toggleTimer(plugNum) {
                  const enabled = !timerStates[plugNum].enabled;
                  timerStates[plugNum].enabled = enabled;
                  try {
                      await fetch(`/switch/plug${plugNum}_schedule/turn_${enabled ? 'on' : 'off'}`, { method: 'POST' });
                      updateTimerDisplay(plugNum);
                  } catch (error) {
                      console.error('Error toggling timer:', error);
                  }
              }
              async function adjustTime(plugNum, type, unit, delta) {
                  const state = timerStates[plugNum];
                  const prefix = type === 'on' ? 'on' : 'off';
                  if (unit === 'hour') {
                      let hour = state[`${prefix}Hour`];
                      hour += delta;
                      if (hour < 1) hour = 12;
                      if (hour > 12) hour = 1;
                      state[`${prefix}Hour`] = hour;
                      await fetch(`/number/plug${plugNum}_${type}_hour/set?value=${hour}`, { method: 'POST' });
                  } else {
                      let minute = state[`${prefix}Minute`];
                      minute += delta;
                      if (minute < 0) minute = 59;
                      if (minute > 59) minute = 0;
                      state[`${prefix}Minute`] = minute;
                      await fetch(`/number/plug${plugNum}_${type}_minute/set?value=${minute}`, { method: 'POST' });
                  }
                  updateTimerDisplay(plugNum);
              }
              async function toggleAMPM(plugNum, type) {
                  const state = timerStates[plugNum];
                  const prefix = type === 'on' ? 'on' : 'off';
                  const current = state[`${prefix}AMPM`];
                  const newVal = current === 'AM' ? 'PM' : 'AM';
                  state[`${prefix}AMPM`] = newVal;
                  await fetch(`/select/plug${plugNum}_${type}_ampm/set?option=${newVal}`, { method: 'POST' });
                  updateTimerDisplay(plugNum);
              }
              function updateTimerDisplay(plugNum) {
                  const state = timerStates[plugNum];
                  document.getElementById(`timer${plugNum}Title`).textContent = `${plugStates[plugNum].name} TIMER`;
                  document.getElementById(`timer${plugNum}IP`).textContent = `IP: ${plugStates[plugNum].ip || 'Not Set'}`;
                  const toggleBtn = document.getElementById(`timer${plugNum}Toggle`);
                  toggleBtn.textContent = `Timer: ${state.enabled ? 'ON' : 'OFF'}`;
                  toggleBtn.className = `timer-toggle ${state.enabled ? 'enabled' : ''}`;
                  document.getElementById(`timer${plugNum}OnTime`).textContent = `ON: ${String(state.onHour).padStart(2, '0')}:${String(state.onMinute).padStart(2, '0')} ${state.onAMPM}`;
                  document.getElementById(`timer${plugNum}OffTime`).textContent = `OFF: ${String(state.offHour).padStart(2, '0')}:${String(state.offMinute).padStart(2, '0')} ${state.offAMPM}`;
              }
              async function updatePlugStates() {
                  try {
                      const response = await fetch('/text');
                      const data = await response.json();
                      for (let i = 1; i <= 8; i++) {
                          const nameObj = data.find(t => t.id === `plug${i}_name`);
                          const ipObj = data.find(t => t.id === `plug${i}_ip`);
                          if (nameObj) plugStates[i].name = nameObj.value || `PLUG ${i}`;
                          if (ipObj) plugStates[i].ip = ipObj.value || '';
                          updatePlugButton(i);
                      }
                  } catch (error) {
                      console.error('Error fetching states:', error);
                  }
                  try {
                      const response = await fetch('/binary_sensor');
                      const data = await response.json();
                      for (let i = 1; i <= 8; i++) {
                          const stateObj = data.find(s => s.id === `plug${i}_state`);
                          if (stateObj) {
                              plugStates[i].state = stateObj.value === 'ON';
                              updatePlugButton(i);
                          }
                      }
                  } catch (error) {
                      console.error('Error fetching binary sensor states:', error);
                  }
              }
              async function updateTimerSettings() {
                  try {
                      const [switches, numbers, selects] = await Promise.all([
                          fetch('/switch').then(r => r.json()),
                          fetch('/number').then(r => r.json()),
                          fetch('/select').then(r => r.json())
                      ]);
                      for (let i = 1; i <= 8; i++) {
                          const scheduleSwitch = switches.find(s => s.id === `plug${i}_schedule`);
                          if (scheduleSwitch) {
                              timerStates[i].enabled = scheduleSwitch.value === 'ON';
                          }
                          const onHour = numbers.find(n => n.id === `plug${i}_on_hour`);
                          const onMinute = numbers.find(n => n.id === `plug${i}_on_minute`);
                          const offHour = numbers.find(n => n.id === `plug${i}_off_hour`);
                          const offMinute = numbers.find(n => n.id === `plug${i}_off_minute`);
                          if (onHour) timerStates[i].onHour = parseInt(onHour.value);
                          if (onMinute) timerStates[i].onMinute = parseInt(onMinute.value);
                          if (offHour) timerStates[i].offHour = parseInt(offHour.value);
                          if (offMinute) timerStates[i].offMinute = parseInt(offMinute.value);
                          const onAMPM = selects.find(s => s.id === `plug${i}_on_ampm`);
                          const offAMPM = selects.find(s => s.id === `plug${i}_off_ampm`);
                          if (onAMPM) timerStates[i].onAMPM = onAMPM.value;
                          if (offAMPM) timerStates[i].offAMPM = offAMPM.value;
                      }
                  } catch (error) {
                      console.error('Error fetching timer settings:', error);
                  }
              }
              async function updateNumPlugs() {
                  try {
                      const response = await fetch('/number');
                      const data = await response.json();
                      const numPlugsObj = data.find(n => n.id === 'num_plugs');
                      if (numPlugsObj) {
                          numPlugsActive = parseInt(numPlugsObj.value);
                          updateVisiblePlugs();
                      }
                  } catch (error) {
                      console.error('Error fetching number of plugs:', error);
                  }
              }

              async function init() {
                  await updateNumPlugs();
                  await updatePlugStates();
                  await updateTimerSettings();
                  for (let i = 1; i <= 8; i++) {
                      updatePlugButton(i);
                      updateTimerDisplay(i);
                  }
                  setInterval(updatePlugStates, 5000);
                  setInterval(updateTimerSettings, 10000);
                  setInterval(updateNumPlugs, 10000);  // Check for plug count changes
              }
              init();
          </script>
      </body>
      </html>
      )rawliteral";

      auto *web_server = (AsyncWebServer*) id(web_server_base_id).get_server();
      web_server->on("/", HTTP_GET, [](AsyncWebServerRequest *request){
        request->send(200, "text/html", WAVESHARE_UI_HTML);
      });

      return {};

# HTTP client for Kauf plug control
http_request:
  id: http_client
  timeout: 2s

# Time component for scheduling
time:
  - platform: sntp
    id: sntp_time
    timezone: America/Detroit

# Preferences - immediate flash writes
preferences:
  flash_write_interval: 0s

# ============================================
# NUMBER - Configure Number of Plugs
# ============================================
number:
  - platform: template
    id: num_plugs
    name: "Number of Plugs"
    optimistic: true
    min_value: 1
    max_value: 8
    step: 1
    initial_value: 8
    restore_value: true
    mode: box

# ============================================
# TEXT - Configurable Plug Names and IPs
# ============================================
text:
  # Plug 1 Configuration
  - platform: template
    id: plug1_name
    name: "Plug 1 Name"
    optimistic: true
    min_length: 0
    max_length: 20
    initial_value: "PLUG 1"
    mode: text
    restore_value: true

  - platform: template
    id: plug1_ip
    name: "Plug 1 IP Address"
    optimistic: true
    min_length: 0
    max_length: 15
    initial_value: "192.168.68.79"
    mode: text
    restore_value: true

  # Plug 2 Configuration
  - platform: template
    id: plug2_name
    name: "Plug 2 Name"
    optimistic: true
    min_length: 0
    max_length: 20
    initial_value: "PLUG 2"
    mode: text
    restore_value: true

  - platform: template
    id: plug2_ip
    name: "Plug 2 IP Address"
    optimistic: true
    min_length: 0
    max_length: 15
    initial_value: "192.168.68.77"
    mode: text
    restore_value: true

  # Plug 3 Configuration
  - platform: template
    id: plug3_name
    name: "Plug 3 Name"
    optimistic: true
    min_length: 0
    max_length: 20
    initial_value: "PLUG 3"
    mode: text
    restore_value: true

  - platform: template
    id: plug3_ip
    name: "Plug 3 IP Address"
    optimistic: true
    min_length: 0
    max_length: 15
    initial_value: "192.168.68.76"
    mode: text
    restore_value: true

  # Plug 4 Configuration
  - platform: template
    id: plug4_name
    name: "Plug 4 Name"
    optimistic: true
    min_length: 0
    max_length: 20
    initial_value: "PLUG 4"
    mode: text
    restore_value: true

  - platform: template
    id: plug4_ip
    name: "Plug 4 IP Address"
    optimistic: true
    min_length: 0
    max_length: 15
    initial_value: "192.168.68.75"
    mode: text
    restore_value: true

  # Plug 5 Configuration
  - platform: template
    id: plug5_name
    name: "Plug 5 Name"
    optimistic: true
    min_length: 0
    max_length: 20
    initial_value: "PLUG 5"
    mode: text
    restore_value: true

  - platform: template
    id: plug5_ip
    name: "Plug 5 IP Address"
    optimistic: true
    min_length: 0
    max_length: 15
    initial_value: "192.168.68.203"
    mode: text
    restore_value: true

  # Plug 6 Configuration
  - platform: template
    id: plug6_name
    name: "Plug 6 Name"
    optimistic: true
    min_length: 0
    max_length: 20
    initial_value: "PLUG 6"
    mode: text
    restore_value: true

  - platform: template
    id: plug6_ip
    name: "Plug 6 IP Address"
    optimistic: true
    min_length: 0
    max_length: 15
    initial_value: "192.168.68.204"
    mode: text
    restore_value: true

  # Plug 7 Configuration
  - platform: template
    id: plug7_name
    name: "Plug 7 Name"
    optimistic: true
    min_length: 0
    max_length: 20
    initial_value: "PLUG 7"
    mode: text
    restore_value: true

  - platform: template
    id: plug7_ip
    name: "Plug 7 IP Address"
    optimistic: true
    min_length: 0
    max_length: 15
    initial_value: "192.168.68.205"
    mode: text
    restore_value: true

  # Plug 8 Configuration
  - platform: template
    id: plug8_name
    name: "Plug 8 Name"
    optimistic: true
    min_length: 0
    max_length: 20
    initial_value: "PLUG 8"
    mode: text
    restore_value: true

  - platform: template
    id: plug8_ip
    name: "Plug 8 IP Address"
    optimistic: true
    min_length: 0
    max_length: 15
    initial_value: "192.168.68.206"
    mode: text
    restore_value: true

# ============================================
# GLOBALS - Timer Settings (Persisted to Flash)
# ============================================
globals:
  # Plug 1 Timer Settings
  - id: plug1_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug1_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug1_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug1_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug1_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug1_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug1_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  # Plug 2 Timer Settings
  - id: plug2_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug2_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug2_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug2_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug2_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug2_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug2_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  # Plug 3 Timer Settings
  - id: plug3_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug3_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug3_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug3_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug3_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug3_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug3_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  # Plug 4 Timer Settings
  - id: plug4_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug4_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug4_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug4_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug4_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug4_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug4_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  # Plug 5 Timer Settings
  - id: plug5_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug5_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug5_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug5_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug5_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug5_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug5_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  # Plug 6 Timer Settings
  - id: plug6_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug6_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug6_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug6_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug6_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug6_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug6_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  # Plug 7 Timer Settings
  - id: plug7_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug7_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug7_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug7_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug7_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug7_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug7_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  # Plug 8 Timer Settings
  - id: plug8_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug8_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug8_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug8_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug8_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug8_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug8_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

# ============================================
# BINARY SENSORS - Track Actual Plug States
# ============================================
binary_sensor:
  # Plug 1 State
  - platform: template
    id: plug1_state
    name: "Plug 1 State"
    device_class: power
    lambda: |-
      return false;  // Updated by HTTP response

  # Plug 2 State
  - platform: template
    id: plug2_state
    name: "Plug 2 State"
    device_class: power
    lambda: |-
      return false;

  # Plug 3 State
  - platform: template
    id: plug3_state
    name: "Plug 3 State"
    device_class: power
    lambda: |-
      return false;

  # Plug 4 State
  - platform: template
    id: plug4_state
    name: "Plug 4 State"
    device_class: power
    lambda: |-
      return false;

  # Plug 5 State
  - platform: template
    id: plug5_state
    name: "Plug 5 State"
    device_class: power
    lambda: |-
      return false;

  # Plug 6 State
  - platform: template
    id: plug6_state
    name: "Plug 6 State"
    device_class: power
    lambda: |-
      return false;

  # Plug 7 State
  - platform: template
    id: plug7_state
    name: "Plug 7 State"
    device_class: power
    lambda: |-
      return false;

  # Plug 8 State
  - platform: template
    id: plug8_state
    name: "Plug 8 State"
    device_class: power
    lambda: |-
      return false;

# ============================================
# BUTTONS - Direct Plug Control
# ============================================
button:
  # Plug 1 Controls
  - platform: template
    name: "Plug 1 ON"
    icon: mdi:power-plug
    on_press:
      - script.execute: plug1_turn_on

  - platform: template
    name: "Plug 1 OFF"
    icon: mdi:power-plug-off
    on_press:
      - script.execute: plug1_turn_off

  # Plug 2 Controls
  - platform: template
    name: "Plug 2 ON"
    icon: mdi:power-plug
    on_press:
      - script.execute: plug2_turn_on

  - platform: template
    name: "Plug 2 OFF"
    icon: mdi:power-plug-off
    on_press:
      - script.execute: plug2_turn_off

  # Plug 3 Controls
  - platform: template
    name: "Plug 3 ON"
    icon: mdi:power-plug
    on_press:
      - script.execute: plug3_turn_on

  - platform: template
    name: "Plug 3 OFF"
    icon: mdi:power-plug-off
    on_press:
      - script.execute: plug3_turn_off

  # Plug 4 Controls
  - platform: template
    name: "Plug 4 ON"
    icon: mdi:power-plug
    on_press:
      - script.execute: plug4_turn_on

  - platform: template
    name: "Plug 4 OFF"
    icon: mdi:power-plug-off
    on_press:
      - script.execute: plug4_turn_off

  # Plug 5 Controls
  - platform: template
    name: "Plug 5 ON"
    icon: mdi:power-plug
    on_press:
      - script.execute: plug5_turn_on

  - platform: template
    name: "Plug 5 OFF"
    icon: mdi:power-plug-off
    on_press:
      - script.execute: plug5_turn_off

  # Plug 6 Controls
  - platform: template
    name: "Plug 6 ON"
    icon: mdi:power-plug
    on_press:
      - script.execute: plug6_turn_on

  - platform: template
    name: "Plug 6 OFF"
    icon: mdi:power-plug-off
    on_press:
      - script.execute: plug6_turn_off

  # Plug 7 Controls
  - platform: template
    name: "Plug 7 ON"
    icon: mdi:power-plug
    on_press:
      - script.execute: plug7_turn_on

  - platform: template
    name: "Plug 7 OFF"
    icon: mdi:power-plug-off
    on_press:
      - script.execute: plug7_turn_off

  # Plug 8 Controls
  - platform: template
    name: "Plug 8 ON"
    icon: mdi:power-plug
    on_press:
      - script.execute: plug8_turn_on

  - platform: template
    name: "Plug 8 OFF"
    icon: mdi:power-plug-off
    on_press:
      - script.execute: plug8_turn_off

# ============================================
# SWITCHES - Timer Enable/Disable
# ============================================
switch:
  # Plug 1 Timer Enable
  - platform: template
    id: plug1_schedule_enabled
    name: "Plug 1 Timer"
    icon: mdi:timer
    lambda: |-
      return id(plug1_schedule_persist);
    turn_on_action:
      - lambda: id(plug1_schedule_persist) = true;
    turn_off_action:
      - lambda: id(plug1_schedule_persist) = false;

  # Plug 2 Timer Enable
  - platform: template
    id: plug2_schedule_enabled
    name: "Plug 2 Timer"
    icon: mdi:timer
    lambda: |-
      return id(plug2_schedule_persist);
    turn_on_action:
      - lambda: id(plug2_schedule_persist) = true;
    turn_off_action:
      - lambda: id(plug2_schedule_persist) = false;

  # Plug 3 Timer Enable
  - platform: template
    id: plug3_schedule_enabled
    name: "Plug 3 Timer"
    icon: mdi:timer
    lambda: |-
      return id(plug3_schedule_persist);
    turn_on_action:
      - lambda: id(plug3_schedule_persist) = true;
    turn_off_action:
      - lambda: id(plug3_schedule_persist) = false;

  # Plug 4 Timer Enable
  - platform: template
    id: plug4_schedule_enabled
    name: "Plug 4 Timer"
    icon: mdi:timer
    lambda: |-
      return id(plug4_schedule_persist);
    turn_on_action:
      - lambda: id(plug4_schedule_persist) = true;
    turn_off_action:
      - lambda: id(plug4_schedule_persist) = false;

  # Plug 5 Timer Enable
  - platform: template
    id: plug5_schedule_enabled
    name: "Plug 5 Timer"
    icon: mdi:timer
    lambda: |-
      return id(plug5_schedule_persist);
    turn_on_action:
      - lambda: id(plug5_schedule_persist) = true;
    turn_off_action:
      - lambda: id(plug5_schedule_persist) = false;

  # Plug 6 Timer Enable
  - platform: template
    id: plug6_schedule_enabled
    name: "Plug 6 Timer"
    icon: mdi:timer
    lambda: |-
      return id(plug6_schedule_persist);
    turn_on_action:
      - lambda: id(plug6_schedule_persist) = true;
    turn_off_action:
      - lambda: id(plug6_schedule_persist) = false;

  # Plug 7 Timer Enable
  - platform: template
    id: plug7_schedule_enabled
    name: "Plug 7 Timer"
    icon: mdi:timer
    lambda: |-
      return id(plug7_schedule_persist);
    turn_on_action:
      - lambda: id(plug7_schedule_persist) = true;
    turn_off_action:
      - lambda: id(plug7_schedule_persist) = false;

  # Plug 8 Timer Enable
  - platform: template
    id: plug8_schedule_enabled
    name: "Plug 8 Timer"
    icon: mdi:timer
    lambda: |-
      return id(plug8_schedule_persist);
    turn_on_action:
      - lambda: id(plug8_schedule_persist) = true;
    turn_off_action:
      - lambda: id(plug8_schedule_persist) = false;

# ============================================
# NUMBERS - Timer Hours and Minutes
# ============================================
number:
  # Plug 1 Timer Settings
  - platform: template
    id: plug1_on_hour
    name: "Plug 1 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug1_on_hour_persist);
    set_action:
      - lambda: id(plug1_on_hour_persist) = (int)x;

  - platform: template
    id: plug1_on_minute
    name: "Plug 1 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug1_on_minute_persist);
    set_action:
      - lambda: id(plug1_on_minute_persist) = (int)x;

  - platform: template
    id: plug1_off_hour
    name: "Plug 1 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug1_off_hour_persist);
    set_action:
      - lambda: id(plug1_off_hour_persist) = (int)x;

  - platform: template
    id: plug1_off_minute
    name: "Plug 1 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug1_off_minute_persist);
    set_action:
      - lambda: id(plug1_off_minute_persist) = (int)x;

  # Plug 2 Timer Settings
  - platform: template
    id: plug2_on_hour
    name: "Plug 2 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug2_on_hour_persist);
    set_action:
      - lambda: id(plug2_on_hour_persist) = (int)x;

  - platform: template
    id: plug2_on_minute
    name: "Plug 2 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug2_on_minute_persist);
    set_action:
      - lambda: id(plug2_on_minute_persist) = (int)x;

  - platform: template
    id: plug2_off_hour
    name: "Plug 2 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug2_off_hour_persist);
    set_action:
      - lambda: id(plug2_off_hour_persist) = (int)x;

  - platform: template
    id: plug2_off_minute
    name: "Plug 2 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug2_off_minute_persist);
    set_action:
      - lambda: id(plug2_off_minute_persist) = (int)x;

  # Plug 3 Timer Settings
  - platform: template
    id: plug3_on_hour
    name: "Plug 3 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug3_on_hour_persist);
    set_action:
      - lambda: id(plug3_on_hour_persist) = (int)x;

  - platform: template
    id: plug3_on_minute
    name: "Plug 3 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug3_on_minute_persist);
    set_action:
      - lambda: id(plug3_on_minute_persist) = (int)x;

  - platform: template
    id: plug3_off_hour
    name: "Plug 3 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug3_off_hour_persist);
    set_action:
      - lambda: id(plug3_off_hour_persist) = (int)x;

  - platform: template
    id: plug3_off_minute
    name: "Plug 3 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug3_off_minute_persist);
    set_action:
      - lambda: id(plug3_off_minute_persist) = (int)x;

  # Plug 4 Timer Settings
  - platform: template
    id: plug4_on_hour
    name: "Plug 4 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug4_on_hour_persist);
    set_action:
      - lambda: id(plug4_on_hour_persist) = (int)x;

  - platform: template
    id: plug4_on_minute
    name: "Plug 4 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug4_on_minute_persist);
    set_action:
      - lambda: id(plug4_on_minute_persist) = (int)x;

  - platform: template
    id: plug4_off_hour
    name: "Plug 4 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug4_off_hour_persist);
    set_action:
      - lambda: id(plug4_off_hour_persist) = (int)x;

  - platform: template
    id: plug4_off_minute
    name: "Plug 4 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug4_off_minute_persist);
    set_action:
      - lambda: id(plug4_off_minute_persist) = (int)x;

  # Plug 5 Timer Settings
  - platform: template
    id: plug5_on_hour
    name: "Plug 5 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug5_on_hour_persist);
    set_action:
      - lambda: id(plug5_on_hour_persist) = (int)x;

  - platform: template
    id: plug5_on_minute
    name: "Plug 5 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug5_on_minute_persist);
    set_action:
      - lambda: id(plug5_on_minute_persist) = (int)x;

  - platform: template
    id: plug5_off_hour
    name: "Plug 5 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug5_off_hour_persist);
    set_action:
      - lambda: id(plug5_off_hour_persist) = (int)x;

  - platform: template
    id: plug5_off_minute
    name: "Plug 5 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug5_off_minute_persist);
    set_action:
      - lambda: id(plug5_off_minute_persist) = (int)x;

  # Plug 6 Timer Settings
  - platform: template
    id: plug6_on_hour
    name: "Plug 6 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug6_on_hour_persist);
    set_action:
      - lambda: id(plug6_on_hour_persist) = (int)x;

  - platform: template
    id: plug6_on_minute
    name: "Plug 6 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug6_on_minute_persist);
    set_action:
      - lambda: id(plug6_on_minute_persist) = (int)x;

  - platform: template
    id: plug6_off_hour
    name: "Plug 6 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug6_off_hour_persist);
    set_action:
      - lambda: id(plug6_off_hour_persist) = (int)x;

  - platform: template
    id: plug6_off_minute
    name: "Plug 6 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug6_off_minute_persist);
    set_action:
      - lambda: id(plug6_off_minute_persist) = (int)x;

  # Plug 7 Timer Settings
  - platform: template
    id: plug7_on_hour
    name: "Plug 7 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug7_on_hour_persist);
    set_action:
      - lambda: id(plug7_on_hour_persist) = (int)x;

  - platform: template
    id: plug7_on_minute
    name: "Plug 7 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug7_on_minute_persist);
    set_action:
      - lambda: id(plug7_on_minute_persist) = (int)x;

  - platform: template
    id: plug7_off_hour
    name: "Plug 7 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug7_off_hour_persist);
    set_action:
      - lambda: id(plug7_off_hour_persist) = (int)x;

  - platform: template
    id: plug7_off_minute
    name: "Plug 7 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug7_off_minute_persist);
    set_action:
      - lambda: id(plug7_off_minute_persist) = (int)x;

  # Plug 8 Timer Settings
  - platform: template
    id: plug8_on_hour
    name: "Plug 8 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug8_on_hour_persist);
    set_action:
      - lambda: id(plug8_on_hour_persist) = (int)x;

  - platform: template
    id: plug8_on_minute
    name: "Plug 8 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug8_on_minute_persist);
    set_action:
      - lambda: id(plug8_on_minute_persist) = (int)x;

  - platform: template
    id: plug8_off_hour
    name: "Plug 8 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug8_off_hour_persist);
    set_action:
      - lambda: id(plug8_off_hour_persist) = (int)x;

  - platform: template
    id: plug8_off_minute
    name: "Plug 8 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    icon: mdi:clock-outline
    lambda: |-
      return (float)id(plug8_off_minute_persist);
    set_action:
      - lambda: id(plug8_off_minute_persist) = (int)x;

# ============================================
# SELECTS - AM/PM Selection
# ============================================
select:
  # Plug 1 AM/PM
  - platform: template
    id: plug1_on_ampm
    name: "Plug 1 On AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug1_on_ampm_persist);
    set_action:
      - lambda: id(plug1_on_ampm_persist) = x;

  - platform: template
    id: plug1_off_ampm
    name: "Plug 1 Off AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug1_off_ampm_persist);
    set_action:
      - lambda: id(plug1_off_ampm_persist) = x;

  # Plug 2 AM/PM
  - platform: template
    id: plug2_on_ampm
    name: "Plug 2 On AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug2_on_ampm_persist);
    set_action:
      - lambda: id(plug2_on_ampm_persist) = x;

  - platform: template
    id: plug2_off_ampm
    name: "Plug 2 Off AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug2_off_ampm_persist);
    set_action:
      - lambda: id(plug2_off_ampm_persist) = x;

  # Plug 3 AM/PM
  - platform: template
    id: plug3_on_ampm
    name: "Plug 3 On AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug3_on_ampm_persist);
    set_action:
      - lambda: id(plug3_on_ampm_persist) = x;

  - platform: template
    id: plug3_off_ampm
    name: "Plug 3 Off AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug3_off_ampm_persist);
    set_action:
      - lambda: id(plug3_off_ampm_persist) = x;

  # Plug 4 AM/PM
  - platform: template
    id: plug4_on_ampm
    name: "Plug 4 On AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug4_on_ampm_persist);
    set_action:
      - lambda: id(plug4_on_ampm_persist) = x;

  - platform: template
    id: plug4_off_ampm
    name: "Plug 4 Off AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug4_off_ampm_persist);
    set_action:
      - lambda: id(plug4_off_ampm_persist) = x;

  # Plug 5 AM/PM
  - platform: template
    id: plug5_on_ampm
    name: "Plug 5 On AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug5_on_ampm_persist);
    set_action:
      - lambda: id(plug5_on_ampm_persist) = x;

  - platform: template
    id: plug5_off_ampm
    name: "Plug 5 Off AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug5_off_ampm_persist);
    set_action:
      - lambda: id(plug5_off_ampm_persist) = x;

  # Plug 6 AM/PM
  - platform: template
    id: plug6_on_ampm
    name: "Plug 6 On AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug6_on_ampm_persist);
    set_action:
      - lambda: id(plug6_on_ampm_persist) = x;

  - platform: template
    id: plug6_off_ampm
    name: "Plug 6 Off AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug6_off_ampm_persist);
    set_action:
      - lambda: id(plug6_off_ampm_persist) = x;

  # Plug 7 AM/PM
  - platform: template
    id: plug7_on_ampm
    name: "Plug 7 On AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug7_on_ampm_persist);
    set_action:
      - lambda: id(plug7_on_ampm_persist) = x;

  - platform: template
    id: plug7_off_ampm
    name: "Plug 7 Off AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug7_off_ampm_persist);
    set_action:
      - lambda: id(plug7_off_ampm_persist) = x;

  # Plug 8 AM/PM
  - platform: template
    id: plug8_on_ampm
    name: "Plug 8 On AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug8_on_ampm_persist);
    set_action:
      - lambda: id(plug8_on_ampm_persist) = x;

  - platform: template
    id: plug8_off_ampm
    name: "Plug 8 Off AM/PM"
    options: ["AM", "PM"]
    icon: mdi:clock-outline
    lambda: |-
      return id(plug8_off_ampm_persist);
    set_action:
      - lambda: id(plug8_off_ampm_persist) = x;

# ============================================
# SCRIPTS - HTTP Control for Kauf Plugs (Dynamic IPs)
# ============================================
script:
  # Plug 1 Scripts
  - id: plug1_turn_on
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip).state + std::string("/switch/kauf_plug/turn_on");

  - id: plug1_turn_off
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip).state + std::string("/switch/kauf_plug/turn_off");

  # Plug 2 Scripts
  - id: plug2_turn_on
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug2_ip).state + std::string("/switch/kauf_plug/turn_on");

  - id: plug2_turn_off
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug2_ip).state + std::string("/switch/kauf_plug/turn_off");

  # Plug 3 Scripts
  - id: plug3_turn_on
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug3_ip).state + std::string("/switch/kauf_plug/turn_on");

  - id: plug3_turn_off
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug3_ip).state + std::string("/switch/kauf_plug/turn_off");

  # Plug 4 Scripts
  - id: plug4_turn_on
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug4_ip).state + std::string("/switch/kauf_plug/turn_on");

  - id: plug4_turn_off
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug4_ip).state + std::string("/switch/kauf_plug/turn_off");

  # Plug 5 Scripts
  - id: plug5_turn_on
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug5_ip).state + std::string("/switch/kauf_plug/turn_on");

  - id: plug5_turn_off
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug5_ip).state + std::string("/switch/kauf_plug/turn_off");

  # Plug 6 Scripts
  - id: plug6_turn_on
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug6_ip).state + std::string("/switch/kauf_plug/turn_on");

  - id: plug6_turn_off
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug6_ip).state + std::string("/switch/kauf_plug/turn_off");

  # Plug 7 Scripts
  - id: plug7_turn_on
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug7_ip).state + std::string("/switch/kauf_plug/turn_on");

  - id: plug7_turn_off
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug7_ip).state + std::string("/switch/kauf_plug/turn_off");

  # Plug 8 Scripts
  - id: plug8_turn_on
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug8_ip).state + std::string("/switch/kauf_plug/turn_on");

  - id: plug8_turn_off
    then:
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug8_ip).state + std::string("/switch/kauf_plug/turn_off");

# ============================================
# INTERVAL - Check Timers Every Minute
# ============================================
interval:
  - interval: 60s
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;

          int current_hour = now.hour;
          int current_minute = now.minute;

          // Helper function to convert 12-hour to 24-hour
          auto to_24h = [](int h12, std::string ampm) -> int {
            if (ampm == "AM") {
              return (h12 == 12) ? 0 : h12;
            } else {
              return (h12 == 12) ? 12 : h12 + 12;
            }
          };

          // Plug 1 Schedule Check
          if (id(plug1_schedule_persist)) {
            int on_h = to_24h(id(plug1_on_hour_persist), id(plug1_on_ampm_persist));
            int off_h = to_24h(id(plug1_off_hour_persist), id(plug1_off_ampm_persist));

            if (current_hour == on_h && current_minute == id(plug1_on_minute_persist)) {
              ESP_LOGI("Timer", "Turning ON Plug 1");
              id(plug1_turn_on).execute();
            }
            if (current_hour == off_h && current_minute == id(plug1_off_minute_persist)) {
              ESP_LOGI("Timer", "Turning OFF Plug 1");
              id(plug1_turn_off).execute();
            }
          }

          // Plug 2 Schedule Check
          if (id(plug2_schedule_persist)) {
            int on_h = to_24h(id(plug2_on_hour_persist), id(plug2_on_ampm_persist));
            int off_h = to_24h(id(plug2_off_hour_persist), id(plug2_off_ampm_persist));

            if (current_hour == on_h && current_minute == id(plug2_on_minute_persist)) {
              ESP_LOGI("Timer", "Turning ON Plug 2");
              id(plug2_turn_on).execute();
            }
            if (current_hour == off_h && current_minute == id(plug2_off_minute_persist)) {
              ESP_LOGI("Timer", "Turning OFF Plug 2");
              id(plug2_turn_off).execute();
            }
          }

          // Plug 3 Schedule Check
          if (id(plug3_schedule_persist)) {
            int on_h = to_24h(id(plug3_on_hour_persist), id(plug3_on_ampm_persist));
            int off_h = to_24h(id(plug3_off_hour_persist), id(plug3_off_ampm_persist));

            if (current_hour == on_h && current_minute == id(plug3_on_minute_persist)) {
              ESP_LOGI("Timer", "Turning ON Plug 3");
              id(plug3_turn_on).execute();
            }
            if (current_hour == off_h && current_minute == id(plug3_off_minute_persist)) {
              ESP_LOGI("Timer", "Turning OFF Plug 3");
              id(plug3_turn_off).execute();
            }
          }

          // Plug 4 Schedule Check
          if (id(plug4_schedule_persist)) {
            int on_h = to_24h(id(plug4_on_hour_persist), id(plug4_on_ampm_persist));
            int off_h = to_24h(id(plug4_off_hour_persist), id(plug4_off_ampm_persist));

            if (current_hour == on_h && current_minute == id(plug4_on_minute_persist)) {
              ESP_LOGI("Timer", "Turning ON Plug 4");
              id(plug4_turn_on).execute();
            }
            if (current_hour == off_h && current_minute == id(plug4_off_minute_persist)) {
              ESP_LOGI("Timer", "Turning OFF Plug 4");
              id(plug4_turn_off).execute();
            }
          }

          // Plug 5 Schedule Check
          if (id(plug5_schedule_persist)) {
            int on_h = to_24h(id(plug5_on_hour_persist), id(plug5_on_ampm_persist));
            int off_h = to_24h(id(plug5_off_hour_persist), id(plug5_off_ampm_persist));

            if (current_hour == on_h && current_minute == id(plug5_on_minute_persist)) {
              ESP_LOGI("Timer", "Turning ON Plug 5");
              id(plug5_turn_on).execute();
            }
            if (current_hour == off_h && current_minute == id(plug5_off_minute_persist)) {
              ESP_LOGI("Timer", "Turning OFF Plug 5");
              id(plug5_turn_off).execute();
            }
          }

          // Plug 6 Schedule Check
          if (id(plug6_schedule_persist)) {
            int on_h = to_24h(id(plug6_on_hour_persist), id(plug6_on_ampm_persist));
            int off_h = to_24h(id(plug6_off_hour_persist), id(plug6_off_ampm_persist));

            if (current_hour == on_h && current_minute == id(plug6_on_minute_persist)) {
              ESP_LOGI("Timer", "Turning ON Plug 6");
              id(plug6_turn_on).execute();
            }
            if (current_hour == off_h && current_minute == id(plug6_off_minute_persist)) {
              ESP_LOGI("Timer", "Turning OFF Plug 6");
              id(plug6_turn_off).execute();
            }
          }

          // Plug 7 Schedule Check
          if (id(plug7_schedule_persist)) {
            int on_h = to_24h(id(plug7_on_hour_persist), id(plug7_on_ampm_persist));
            int off_h = to_24h(id(plug7_off_hour_persist), id(plug7_off_ampm_persist));

            if (current_hour == on_h && current_minute == id(plug7_on_minute_persist)) {
              ESP_LOGI("Timer", "Turning ON Plug 7");
              id(plug7_turn_on).execute();
            }
            if (current_hour == off_h && current_minute == id(plug7_off_minute_persist)) {
              ESP_LOGI("Timer", "Turning OFF Plug 7");
              id(plug7_turn_off).execute();
            }
          }

          // Plug 8 Schedule Check
          if (id(plug8_schedule_persist)) {
            int on_h = to_24h(id(plug8_on_hour_persist), id(plug8_on_ampm_persist));
            int off_h = to_24h(id(plug8_off_hour_persist), id(plug8_off_ampm_persist));

            if (current_hour == on_h && current_minute == id(plug8_on_minute_persist)) {
              ESP_LOGI("Timer", "Turning ON Plug 8");
              id(plug8_turn_on).execute();
            }
            if (current_hour == off_h && current_minute == id(plug8_off_minute_persist)) {
              ESP_LOGI("Timer", "Turning OFF Plug 8");
              id(plug8_turn_off).execute();
            }
          }
