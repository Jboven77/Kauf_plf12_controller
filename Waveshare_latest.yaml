substitutions:
  # PLUG IP ADDRESSES - Change these to match your plugs
  plug1_ip: "192.168.68.79"
  plug2_ip: "192.168.68.77"
  plug3_ip: "192.168.68.76"
  plug4_ip: "192.168.68.75"
  plug5_ip: "192.168.68.203"
  plug6_ip: "192.168.68.204"
  plug7_ip: "192.168.68.205"
  plug8_ip: "192.168.68.206"

  # PLUG BUTTON NAMES - Change these to customize button labels (max 12 characters)
  plug1_name: "PLUG 1"
  plug2_name: "PLUG 2"
  plug3_name: "PLUG 3"
  plug4_name: "PLUG 4"
  plug5_name: "PLUG 5"
  plug6_name: "PLUG 6"
  plug7_name: "PLUG 7"
  plug8_name: "PLUG 8"

  # PLUG ENABLE/DISABLE - Set to "true" to enable state checking, "false" to disable
  # Disabled plugs will still show on screen but won't be checked for state updates
  # Use this to prevent timeouts from unplugged/offline devices
  plug1_enabled: "true"
  plug2_enabled: "true"
  plug3_enabled: "true"
  plug4_enabled: "true"
  plug5_enabled: "false"   # Not connected - disable to prevent timeouts
  plug6_enabled: "false"   # Not connected - disable to prevent timeouts
  plug7_enabled: "false"   # Not connected - disable to prevent timeouts
  plug8_enabled: "false"   # Not connected - disable to prevent timeouts

esphome:
  name: waveshare-esp32-s3-7in
  friendly_name: Waveshare ESP32-S3 7in
  min_version: "2025.4.2"
  platformio_options:
    build_flags: "-DBOARD_HAS_PSRAM"
    board_build.arduino.memory_type: qio_opi
    board_build.flash_mode: dio
    board_upload.maximum_ram_size: 524288

psram:
  mode: octal
  speed: 120MHz

esp32:
  board: esp32-s3-devkitc-1
  variant: ESP32S3
  flash_size: 16MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    advanced:
      enable_idf_experimental_features: true
    sdkconfig_options:
      COMPILER_OPTIMIZATION_SIZE: y
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESPTOOLPY_FLASHSIZE_16MB: "y"
      CONFIG_FREERTOS_HZ: "1000"
      CONFIG_ESP_DEFAULT_CPU_FREQ_MHZ_240: y
      CONFIG_ESPTOOLPY_FLASHMODE_QIO: y
      CONFIG_ESPTOOLPY_FLASHFREQ_120M: y
      CONFIG_SPIRAM_MODE_OCT: y
      CONFIG_IDF_EXPERIMENTAL_FEATURES: y
      CONFIG_SPIRAM_SPEED_120M: y
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: y
      CONFIG_COMPILER_OPTIMIZATION_PERF: y
      # Performance optimizations
      CONFIG_FREERTOS_UNICORE: n
      CONFIG_ESP_TASK_WDT_TIMEOUT_S: "10"
      CONFIG_ESP_TASK_WDT_CHECK_IDLE_TASK_CPU0: n
      CONFIG_ESP_TASK_WDT_CHECK_IDLE_TASK_CPU1: n
      CONFIG_LWIP_TCP_MSS: "1436"
      CONFIG_LWIP_TCP_WND: "5744"
      CONFIG_LWIP_TCP_SND_BUF: "5744"
      CONFIG_LWIP_TCPIP_RECVMBOX_SIZE: "32"
      CONFIG_LWIP_UDP_RECVMBOX_SIZE: "16"
      # NVS (Non-Volatile Storage) configuration for preferences
      CONFIG_NVS_ENCRYPTION: n
      CONFIG_NVS_COMPATIBLE_PRE_V43_ENCRYPTION: n

logger:
  level: ERROR  # Reduced from WARN for better performance

preferences:
  flash_write_interval: 0s  # Save to flash immediately on every change

wifi:
  ssid: "JEREMY"
  password: "605506Jdb"
  power_save_mode: NONE
  reboot_timeout: 0s

  ap:
    ssid: "WaveshareS3-7in Fallback"
    password: "12345678"

captive_portal:

api:
  reboot_timeout: 0s
  encryption:
    key: "+6lkh+FkWq3HVFh6+NukfmN188wGMQap7sw2RK1p9Gg="

ota:
  - platform: esphome
    password: "48170f28ed94e6fe392d67906b01ff74"

http_request:
  id: http_client
  timeout: 300ms

i2c:
  sda: GPIO08
  scl: GPIO09
  scan: true
  id: bus_a

ch422g:
  - id: ch422g_hub

output:
  - platform: ledc
    id: lcdbacklight_output
    pin: GPIO16
    frequency: 1000 Hz

light:
  - platform: monochromatic
    id: lcdbacklight
    name: LCD Backlight
    output: lcdbacklight_output
    icon: mdi:wall-sconce-flat-outline
    disabled_by_default: true
    restore_mode: ALWAYS_ON

globals:
  - id: last_activity
    type: uint32_t
    restore_value: no
    initial_value: "0"

  - id: bl_mode
    type: int
    restore_value: yes
    initial_value: "0"

  - id: bl_level
    type: int
    restore_value: yes
    initial_value: "100"

  - id: plug_check_counter
    type: int
    restore_value: no
    initial_value: "0"

  - id: bg_animation_step
    type: int
    restore_value: no
    initial_value: "0"

  # Failure tracking for smart skipping of problematic plugs
  - id: plug1_failure_count
    type: int
    restore_value: no
    initial_value: "0"
  - id: plug2_failure_count
    type: int
    restore_value: no
    initial_value: "0"
  - id: plug3_failure_count
    type: int
    restore_value: no
    initial_value: "0"
  - id: plug4_failure_count
    type: int
    restore_value: no
    initial_value: "0"

  # Plug enable/disable flags (from substitutions at top of file)
  - id: plug1_enabled
    type: bool
    restore_value: no
    initial_value: '${plug1_enabled}'
  - id: plug2_enabled
    type: bool
    restore_value: no
    initial_value: '${plug2_enabled}'
  - id: plug3_enabled
    type: bool
    restore_value: no
    initial_value: '${plug3_enabled}'
  - id: plug4_enabled
    type: bool
    restore_value: no
    initial_value: '${plug4_enabled}'
  - id: plug5_enabled
    type: bool
    restore_value: no
    initial_value: '${plug5_enabled}'
  - id: plug6_enabled
    type: bool
    restore_value: no
    initial_value: '${plug6_enabled}'
  - id: plug7_enabled
    type: bool
    restore_value: no
    initial_value: '${plug7_enabled}'
  - id: plug8_enabled
    type: bool
    restore_value: no
    initial_value: '${plug8_enabled}'

  - id: plug1_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug2_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug3_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug4_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug5_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug6_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug7_ui_state
    type: bool
    restore_value: no
    initial_value: "false"
  - id: plug8_ui_state
    type: bool
    restore_value: no
    initial_value: "false"

  # Plug IP addresses (configured in substitutions at top of file)
  - id: plug1_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"${plug1_ip}"'
  - id: plug2_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"${plug2_ip}"'
  - id: plug3_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"${plug3_ip}"'
  - id: plug4_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"${plug4_ip}"'
  - id: plug5_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"${plug5_ip}"'
  - id: plug6_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"${plug6_ip}"'
  - id: plug7_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"${plug7_ip}"'
  - id: plug8_ip_str
    type: std::string
    restore_value: yes
    max_restore_data_length: 20
    initial_value: '"${plug8_ip}"'

  # Plug button names (configured in substitutions at top of file)
  - id: plug1_name
    type: std::string
    restore_value: yes
    max_restore_data_length: 30
    initial_value: '"${plug1_name}"'
  - id: plug2_name
    type: std::string
    restore_value: yes
    max_restore_data_length: 30
    initial_value: '"${plug2_name}"'
  - id: plug3_name
    type: std::string
    restore_value: yes
    max_restore_data_length: 30
    initial_value: '"${plug3_name}"'
  - id: plug4_name
    type: std::string
    restore_value: yes
    max_restore_data_length: 30
    initial_value: '"${plug4_name}"'
  - id: plug5_name
    type: std::string
    restore_value: yes
    max_restore_data_length: 30
    initial_value: '"${plug5_name}"'
  - id: plug6_name
    type: std::string
    restore_value: yes
    max_restore_data_length: 30
    initial_value: '"${plug6_name}"'
  - id: plug7_name
    type: std::string
    restore_value: yes
    max_restore_data_length: 30
    initial_value: '"${plug7_name}"'
  - id: plug8_name
    type: std::string
    restore_value: yes
    max_restore_data_length: 30
    initial_value: '"${plug8_name}"'


  - id: plug1_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug1_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug1_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug1_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug1_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug1_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug1_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug2_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug2_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug2_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug2_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug2_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug2_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug2_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug3_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug3_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug3_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug3_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug3_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug3_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug3_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug4_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug4_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug4_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug4_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug4_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug4_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug4_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug5_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug5_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug5_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug5_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug5_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug5_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug5_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug6_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug6_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug6_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug6_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug6_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug6_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug6_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug7_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug7_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug7_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug7_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug7_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug7_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug7_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

  - id: plug8_schedule_persist
    type: bool
    restore_value: yes
    initial_value: 'false'
  - id: plug8_on_hour_persist
    type: int
    restore_value: yes
    initial_value: '8'
  - id: plug8_on_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug8_off_hour_persist
    type: int
    restore_value: yes
    initial_value: '6'
  - id: plug8_off_minute_persist
    type: int
    restore_value: yes
    initial_value: '0'
  - id: plug8_on_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"AM"'
  - id: plug8_off_ampm_persist
    type: std::string
    restore_value: yes
    max_restore_data_length: 4
    initial_value: '"PM"'

switch:
  - platform: gpio
    id: lcd_backlight_sw
    internal: true
    pin:
      ch422g: ch422g_hub
      number: 2
      mode:
        output: true
      inverted: false
    restore_mode: ALWAYS_ON

  - platform: template
    id: plug1_schedule_enabled
    name: "Plug 1 Schedule Enabled"
    entity_category: "config"
    lambda: |-
      return id(plug1_schedule_persist);
    turn_on_action:
      - lambda: |-
          id(plug1_schedule_persist) = true;
          lv_label_set_text(id(lbl_schedule1_state), "Timer: ON");
          lv_obj_set_style_bg_color(id(btn_plug1_timer), lv_color_hex(0x228B22), LV_PART_MAIN);
    turn_off_action:
      - lambda: |-
          id(plug1_schedule_persist) = false;
          lv_label_set_text(id(lbl_schedule1_state), "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug1_timer), lv_color_hex(0x444444), LV_PART_MAIN);

  - platform: template
    id: plug2_schedule_enabled
    name: "Plug 2 Schedule Enabled"
    entity_category: "config"
    lambda: |-
      return id(plug2_schedule_persist);
    turn_on_action:
      - lambda: |-
          id(plug2_schedule_persist) = true;
          lv_label_set_text(id(lbl_schedule2_state), "Timer: ON");
          lv_obj_set_style_bg_color(id(btn_plug2_timer), lv_color_hex(0x228B22), LV_PART_MAIN);
    turn_off_action:
      - lambda: |-
          id(plug2_schedule_persist) = false;
          lv_label_set_text(id(lbl_schedule2_state), "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug2_timer), lv_color_hex(0x444444), LV_PART_MAIN);

  - platform: template
    id: plug3_schedule_enabled
    name: "Plug 3 Schedule Enabled"
    entity_category: "config"
    lambda: |-
      return id(plug3_schedule_persist);
    turn_on_action:
      - lambda: |-
          id(plug3_schedule_persist) = true;
          lv_label_set_text(id(lbl_schedule3_state), "Timer: ON");
          lv_obj_set_style_bg_color(id(btn_plug3_timer), lv_color_hex(0x228B22), LV_PART_MAIN);
    turn_off_action:
      - lambda: |-
          id(plug3_schedule_persist) = false;
          lv_label_set_text(id(lbl_schedule3_state), "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug3_timer), lv_color_hex(0x444444), LV_PART_MAIN);

  - platform: template
    id: plug4_schedule_enabled
    name: "Plug 4 Schedule Enabled"
    entity_category: "config"
    lambda: |-
      return id(plug4_schedule_persist);
    turn_on_action:
      - lambda: |-
          id(plug4_schedule_persist) = true;
          lv_label_set_text(id(lbl_schedule4_state), "Timer: ON");
          lv_obj_set_style_bg_color(id(btn_plug4_timer), lv_color_hex(0x228B22), LV_PART_MAIN);
    turn_off_action:
      - lambda: |-
          id(plug4_schedule_persist) = false;
          lv_label_set_text(id(lbl_schedule4_state), "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug4_timer), lv_color_hex(0x444444), LV_PART_MAIN);

  - platform: template
    id: plug5_schedule_enabled
    name: "Plug 5 Schedule Enabled"
    entity_category: "config"
    lambda: |-
      return id(plug5_schedule_persist);
    turn_on_action:
      - lambda: |-
          id(plug5_schedule_persist) = true;
          lv_label_set_text(id(lbl_schedule5_state), "Timer: ON");
          lv_obj_set_style_bg_color(id(btn_plug5_timer), lv_color_hex(0x228B22), LV_PART_MAIN);
    turn_off_action:
      - lambda: |-
          id(plug5_schedule_persist) = false;
          lv_label_set_text(id(lbl_schedule5_state), "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug5_timer), lv_color_hex(0x444444), LV_PART_MAIN);

  - platform: template
    id: plug6_schedule_enabled
    name: "Plug 6 Schedule Enabled"
    entity_category: "config"
    lambda: |-
      return id(plug6_schedule_persist);
    turn_on_action:
      - lambda: |-
          id(plug6_schedule_persist) = true;
          lv_label_set_text(id(lbl_schedule6_state), "Timer: ON");
          lv_obj_set_style_bg_color(id(btn_plug6_timer), lv_color_hex(0x228B22), LV_PART_MAIN);
    turn_off_action:
      - lambda: |-
          id(plug6_schedule_persist) = false;
          lv_label_set_text(id(lbl_schedule6_state), "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug6_timer), lv_color_hex(0x444444), LV_PART_MAIN);

  - platform: template
    id: plug7_schedule_enabled
    name: "Plug 7 Schedule Enabled"
    entity_category: "config"
    lambda: |-
      return id(plug7_schedule_persist);
    turn_on_action:
      - lambda: |-
          id(plug7_schedule_persist) = true;
          lv_label_set_text(id(lbl_schedule7_state), "Timer: ON");
          lv_obj_set_style_bg_color(id(btn_plug7_timer), lv_color_hex(0x228B22), LV_PART_MAIN);
    turn_off_action:
      - lambda: |-
          id(plug7_schedule_persist) = false;
          lv_label_set_text(id(lbl_schedule7_state), "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug7_timer), lv_color_hex(0x444444), LV_PART_MAIN);

  - platform: template
    id: plug8_schedule_enabled
    name: "Plug 8 Schedule Enabled"
    entity_category: "config"
    lambda: |-
      return id(plug8_schedule_persist);
    turn_on_action:
      - lambda: |-
          id(plug8_schedule_persist) = true;
          lv_label_set_text(id(lbl_schedule8_state), "Timer: ON");
          lv_obj_set_style_bg_color(id(btn_plug8_timer), lv_color_hex(0x228B22), LV_PART_MAIN);
    turn_off_action:
      - lambda: |-
          id(plug8_schedule_persist) = false;
          lv_label_set_text(id(lbl_schedule8_state), "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug8_timer), lv_color_hex(0x444444), LV_PART_MAIN);

script:
  - id: register_activity
    then:
      - lambda: |-
          id(last_activity) = millis();
          id(lcd_backlight_sw).turn_on();
          if (id(bl_mode) == 0) {
            auto call = id(lcdbacklight).turn_on();
            float bri = id(bl_level) / 100.0f;
            call.set_brightness(bri);
            call.perform();
          }

  - id: bl_auto_off_check
    then:
      - lambda: |-
          uint32_t now = millis();
          if (id(last_activity) == 0) {
            id(last_activity) = now;
            return;
          }
          uint32_t timeout_ms = 5UL * 60UL * 1000UL;
          if (id(bl_mode) == 0) {
            if (now - id(last_activity) > timeout_ms) {
              ESP_LOGI("backlight", "Auto-off: turning backlight OFF after 5 min inactivity");
              auto call = id(lcdbacklight).turn_off();
              call.perform();
              id(lcd_backlight_sw).turn_off();
              id(last_activity) = now;
            }
          }

  - id: startup_check_plugs
    then:
      - delay: 3s  # Wait for WiFi to be stable
      - logger.log: "Startup: checking enabled plug states"
      - lambda: |-
          if (id(plug1_enabled)) { id(plug1_update_state).execute(); delay(1000); }
          if (id(plug2_enabled)) { id(plug2_update_state).execute(); delay(1000); }
          if (id(plug3_enabled)) { id(plug3_update_state).execute(); delay(1000); }
          if (id(plug4_enabled)) { id(plug4_update_state).execute(); delay(1000); }
          if (id(plug5_enabled)) { id(plug5_update_state).execute(); delay(1000); }
          if (id(plug6_enabled)) { id(plug6_update_state).execute(); delay(1000); }
          if (id(plug7_enabled)) { id(plug7_update_state).execute(); delay(1000); }
          if (id(plug8_enabled)) { id(plug8_update_state).execute(); delay(1000); }
          ESP_LOGI("Startup", "All enabled plug states checked");

  - id: save_timer_settings
    then:
      - lambda: |-
          // Force immediate preference flush
          global_preferences->sync();
          ESP_LOGI("Persist", "Timer settings saved to flash");

  - id: plug1_turn_on
    then:
      - logger.log: "Schedule: turning Plug 1 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug1_update_state

  - id: plug1_turn_off
    then:
      - logger.log: "Schedule: turning Plug 1 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug1_update_state

  - id: plug2_turn_on
    then:
      - logger.log: "Schedule: turning Plug 2 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug2_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug2_update_state

  - id: plug2_turn_off
    then:
      - logger.log: "Schedule: turning Plug 2 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug2_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug2_update_state

  - id: plug3_turn_on
    then:
      - logger.log: "Schedule: turning Plug 3 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug3_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug3_update_state

  - id: plug3_turn_off
    then:
      - logger.log: "Schedule: turning Plug 3 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug3_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug3_update_state

  - id: plug4_turn_on
    then:
      - logger.log: "Schedule: turning Plug 4 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug4_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug4_update_state

  - id: plug4_turn_off
    then:
      - logger.log: "Schedule: turning Plug 4 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug4_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug4_update_state

  - id: plug5_turn_on
    then:
      - logger.log: "Schedule: turning Plug 5 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug5_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug5_update_state

  - id: plug5_turn_off
    then:
      - logger.log: "Schedule: turning Plug 5 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug5_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug5_update_state

  - id: plug6_turn_on
    then:
      - logger.log: "Schedule: turning Plug 6 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug6_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug6_update_state

  - id: plug6_turn_off
    then:
      - logger.log: "Schedule: turning Plug 6 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug6_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug6_update_state

  - id: plug7_turn_on
    then:
      - logger.log: "Schedule: turning Plug 7 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug7_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug7_update_state

  - id: plug7_turn_off
    then:
      - logger.log: "Schedule: turning Plug 7 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug7_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug7_update_state

  - id: toggle_plug8_device
    then:
      - logger.log: "Manual: toggling Plug 8"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug8_ip_str) + std::string("/switch/kauf_plug/toggle");
      - delay: 500ms
      - script.execute: plug8_update_state

  - id: plug8_turn_on
    then:
      - logger.log: "Schedule: turning Plug 8 ON"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug8_ip_str) + std::string("/switch/kauf_plug/turn_on");
      - delay: 500ms
      - script.execute: plug8_update_state

  - id: plug8_turn_off
    then:
      - logger.log: "Schedule: turning Plug 8 OFF"
      - http_request.post:
          url: !lambda |-
            return std::string("http://") + id(plug8_ip_str) + std::string("/switch/kauf_plug/turn_off");
      - delay: 500ms
      - script.execute: plug8_update_state

  - id: plug1_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug1_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  auto text_col = on ? lv_color_hex(0x000000) : lv_color_hex(0xFFFFFF);
                  lv_obj_set_style_bg_color(id(btn_plug1), col, LV_PART_MAIN);
                  // Update text color - get the label child and set its color
                  lv_obj_t* label = lv_obj_get_child(id(btn_plug1), 0);
                  if (label) lv_obj_set_style_text_color(label, text_col, LV_PART_MAIN);
                  id(plug1_failure_count) = 0;  // Reset failure counter on success
          on_error:
            then:
              - lambda: |-
                  id(plug1_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug1), lv_color_hex(0xFF0000), LV_PART_MAIN);
                  lv_obj_t* label = lv_obj_get_child(id(btn_plug1), 0);
                  if (label) lv_obj_set_style_text_color(label, lv_color_hex(0xFFFFFF), LV_PART_MAIN);
                  id(plug1_failure_count)++;  // Increment failure counter

  - id: plug2_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug2_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug2_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  auto text_col = on ? lv_color_hex(0x000000) : lv_color_hex(0xFFFFFF);
                  lv_obj_set_style_bg_color(id(btn_plug2), col, LV_PART_MAIN);
                  lv_obj_t* label = lv_obj_get_child(id(btn_plug2), 0);
                  if (label) lv_obj_set_style_text_color(label, text_col, LV_PART_MAIN);
                  id(plug2_failure_count) = 0;  // Reset failure counter on success
          on_error:
            then:
              - lambda: |-
                  id(plug2_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug2), lv_color_hex(0xFF0000), LV_PART_MAIN);
                  lv_obj_t* label = lv_obj_get_child(id(btn_plug2), 0);
                  if (label) lv_obj_set_style_text_color(label, lv_color_hex(0xFFFFFF), LV_PART_MAIN);
                  id(plug2_failure_count)++;  // Increment failure counter

  - id: plug3_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug3_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug3_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  auto text_col = on ? lv_color_hex(0x000000) : lv_color_hex(0xFFFFFF);
                  lv_obj_set_style_bg_color(id(btn_plug3), col, LV_PART_MAIN);
                  lv_obj_t* label = lv_obj_get_child(id(btn_plug3), 0);
                  if (label) lv_obj_set_style_text_color(label, text_col, LV_PART_MAIN);
                  id(plug3_failure_count) = 0;  // Reset failure counter on success
          on_error:
            then:
              - lambda: |-
                  id(plug3_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug3), lv_color_hex(0xFF0000), LV_PART_MAIN);
                  lv_obj_t* label = lv_obj_get_child(id(btn_plug3), 0);
                  if (label) lv_obj_set_style_text_color(label, lv_color_hex(0xFFFFFF), LV_PART_MAIN);
                  id(plug3_failure_count)++;  // Increment failure counter

  - id: plug4_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug4_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug4_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  auto text_col = on ? lv_color_hex(0x000000) : lv_color_hex(0xFFFFFF);
                  lv_obj_set_style_bg_color(id(btn_plug4), col, LV_PART_MAIN);
                  lv_obj_t* label = lv_obj_get_child(id(btn_plug4), 0);
                  if (label) lv_obj_set_style_text_color(label, text_col, LV_PART_MAIN);
                  id(plug4_failure_count) = 0;  // Reset failure counter on success
          on_error:
            then:
              - lambda: |-
                  id(plug4_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug4), lv_color_hex(0xFF0000), LV_PART_MAIN);
                  lv_obj_t* label = lv_obj_get_child(id(btn_plug4), 0);
                  if (label) lv_obj_set_style_text_color(label, lv_color_hex(0xFFFFFF), LV_PART_MAIN);
                  id(plug4_failure_count)++;  // Increment failure counter

  - id: plug5_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug5_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug5_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  lv_obj_set_style_bg_color(id(btn_plug5), col, LV_PART_MAIN);
          on_error:
            then:
              - lambda: |-
                  id(plug5_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug5), lv_color_hex(0xFF0000), LV_PART_MAIN);

  - id: plug6_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug6_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug6_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  lv_obj_set_style_bg_color(id(btn_plug6), col, LV_PART_MAIN);
          on_error:
            then:
              - lambda: |-
                  id(plug6_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug6), lv_color_hex(0xFF0000), LV_PART_MAIN);

  - id: plug7_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug7_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug7_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  lv_obj_set_style_bg_color(id(btn_plug7), col, LV_PART_MAIN);
          on_error:
            then:
              - lambda: |-
                  id(plug7_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug7), lv_color_hex(0xFF0000), LV_PART_MAIN);

  - id: plug8_update_state
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug8_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  bool on = body.find("\"state\":\"ON\"") != std::string::npos;
                  id(plug8_ui_state) = on;
                  auto col = on ? lv_color_hex(0x00FF00) : lv_color_hex(0xFF0000);
                  lv_obj_set_style_bg_color(id(btn_plug8), col, LV_PART_MAIN);
          on_error:
            then:
              - lambda: |-
                  id(plug8_ui_state) = false;
                  lv_obj_set_style_bg_color(id(btn_plug8), lv_color_hex(0xFF0000), LV_PART_MAIN);

  - id: fetch_all_plug_info
    then:
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip_str) + std::string("/switch/kauf_plug");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  auto extract = [&](const std::string &k)->std::string {
                    size_t p = body.find(k);
                    if (p == std::string::npos) return std::string("");
                    size_t colon = body.find(':', p);
                    if (colon == std::string::npos) return std::string("");
                    size_t s = colon + 1;
                    while (s < body.size() && (body[s] == ' ' || body[s] == '"')) s++;
                    size_t e = s;
                    while (e < body.size() && ((body[e] >= '0' && body[e] <= '9') || body[e] == '.' || body[e] == '-')) e++;
                    return body.substr(s, e - s);
                  };
                  std::string st = extract("\"state\"");
                  std::string out = "S:" + (st.empty()? std::string("?") : st);
                  lv_label_set_text(id(lbl_plug1_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  lv_label_set_text(id(lbl_plug1_info), "unreachable");
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip_str) + std::string("/sensor/kauf_plug_current");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  std::string val = "-";
                  size_t state_pos = body.find("\"state\":\"");
                  if (state_pos != std::string::npos) {
                    size_t start = state_pos + 9;
                    size_t end = body.find("\"", start);
                    if (end != std::string::npos) {
                      std::string state_str = body.substr(start, end - start);
                      size_t space_pos = state_str.find(" ");
                      if (space_pos != std::string::npos) {
                        val = state_str.substr(0, space_pos);
                      }
                    }
                  }
                  const char *old = lv_label_get_text(id(lbl_plug1_info));
                  std::string out = std::string(old ? old : "") + "  I:" + val + "A";
                  lv_label_set_text(id(lbl_plug1_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  const char *old = lv_label_get_text(id(lbl_plug1_info));
                  std::string out = std::string(old ? old : "") + "  I:-A";
                  lv_label_set_text(id(lbl_plug1_info), out.c_str());
      - http_request.get:
          url: !lambda |-
            return std::string("http://") + id(plug1_ip_str) + std::string("/sensor/kauf_plug_voltage");
          capture_response: true
          on_response:
            then:
              - lambda: |-
                  std::string val = "-";
                  size_t state_pos = body.find("\"state\":\"");
                  if (state_pos != std::string::npos) {
                    size_t start = state_pos + 9;
                    size_t end = body.find("\"", start);
                    if (end != std::string::npos) {
                      std::string state_str = body.substr(start, end - start);
                      size_t space_pos = state_str.find(" ");
                      if (space_pos != std::string::npos) {
                        val = state_str.substr(0, space_pos);
                      }
                    }
                  }
                  const char *old = lv_label_get_text(id(lbl_plug1_info));
                  std::string out = std::string(old ? old : "") + "  V:" + val + "V";
                  lv_label_set_text(id(lbl_plug1_info), out.c_str());
          on_error:
            then:
              - lambda: |-
                  const char *old = lv_label_get_text(id(lbl_plug1_info));
                  std::string out = std::string(old ? old : "") + "  V:-V";
                  lv_label_set_text(id(lbl_plug1_info), out.c_str());
      # Similar blocks for plugs 2-8 omitted for brevity - add them with same pattern

  # IP update scripts - rebuild IP strings from octets
font:
  - file: "gfonts://Roboto"
    id: font_xlarge
    size: 48
  - file: "gfonts://Roboto"
    id: font_large
    size: 26
  - file: "gfonts://Roboto"
    id: font_small
    size: 18

time:
  - platform: sntp
    id: sntp_time
    timezone: America/Detroit  # Eastern Time - Michigan (Zip 49456)

number:
  - platform: template
    id: plug1_on_hour
    name: "Plug 1 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    entity_category: "config"
    lambda: |-
      return (float)id(plug1_on_hour_persist);
    set_action:
      - lambda: |-
          id(plug1_on_hour_persist) = (int)x;
  - platform: template
    id: plug1_on_minute
    name: "Plug 1 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    entity_category: "config"
    lambda: |-
      return (float)id(plug1_on_minute_persist);
    set_action:
      - lambda: |-
          id(plug1_on_minute_persist) = (int)x;
  - platform: template
    id: plug1_off_hour
    name: "Plug 1 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    entity_category: "config"
    lambda: |-
      return (float)id(plug1_off_hour_persist);
    set_action:
      - lambda: |-
          id(plug1_off_hour_persist) = (int)x;
  - platform: template
    id: plug1_off_minute
    name: "Plug 1 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    entity_category: "config"
    lambda: |-
      return (float)id(plug1_off_minute_persist);
    set_action:
      - lambda: |-
          id(plug1_off_minute_persist) = (int)x;

  # Repeat for plugs 2-8
  - platform: template
    id: plug2_on_hour
    name: "Plug 2 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    entity_category: "config"
    lambda: |-
      return (float)id(plug2_on_hour_persist);
    set_action:
      - lambda: |-
          id(plug2_on_hour_persist) = (int)x;
  - platform: template
    id: plug2_on_minute
    name: "Plug 2 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    entity_category: "config"
    lambda: |-
      return (float)id(plug2_on_minute_persist);
    set_action:
      - lambda: |-
          id(plug2_on_minute_persist) = (int)x;
  - platform: template
    id: plug2_off_hour
    name: "Plug 2 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    entity_category: "config"
    lambda: |-
      return (float)id(plug2_off_hour_persist);
    set_action:
      - lambda: |-
          id(plug2_off_hour_persist) = (int)x;
  - platform: template
    id: plug2_off_minute
    name: "Plug 2 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    entity_category: "config"
    lambda: |-
      return (float)id(plug2_off_minute_persist);
    set_action:
      - lambda: |-
          id(plug2_off_minute_persist) = (int)x;

  - platform: template
    id: plug3_on_hour
    name: "Plug 3 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug3_on_hour_persist) = (int)x;
  - platform: template
    id: plug3_on_minute
    name: "Plug 3 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug3_on_minute_persist) = (int)x;
  - platform: template
    id: plug3_off_hour
    name: "Plug 3 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug3_off_hour_persist) = (int)x;
  - platform: template
    id: plug3_off_minute
    name: "Plug 3 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug3_off_minute_persist) = (int)x;

  - platform: template
    id: plug4_on_hour
    name: "Plug 4 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug4_on_hour_persist) = (int)x;
  - platform: template
    id: plug4_on_minute
    name: "Plug 4 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug4_on_minute_persist) = (int)x;
  - platform: template
    id: plug4_off_hour
    name: "Plug 4 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug4_off_hour_persist) = (int)x;
  - platform: template
    id: plug4_off_minute
    name: "Plug 4 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug4_off_minute_persist) = (int)x;

  - platform: template
    id: plug5_on_hour
    name: "Plug 5 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug5_on_hour_persist) = (int)x;
  - platform: template
    id: plug5_on_minute
    name: "Plug 5 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug5_on_minute_persist) = (int)x;
  - platform: template
    id: plug5_off_hour
    name: "Plug 5 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug5_off_hour_persist) = (int)x;
  - platform: template
    id: plug5_off_minute
    name: "Plug 5 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug5_off_minute_persist) = (int)x;

  - platform: template
    id: plug6_on_hour
    name: "Plug 6 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug6_on_hour_persist) = (int)x;
  - platform: template
    id: plug6_on_minute
    name: "Plug 6 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug6_on_minute_persist) = (int)x;
  - platform: template
    id: plug6_off_hour
    name: "Plug 6 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug6_off_hour_persist) = (int)x;
  - platform: template
    id: plug6_off_minute
    name: "Plug 6 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug6_off_minute_persist) = (int)x;

  - platform: template
    id: plug7_on_hour
    name: "Plug 7 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug7_on_hour_persist) = (int)x;
  - platform: template
    id: plug7_on_minute
    name: "Plug 7 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug7_on_minute_persist) = (int)x;
  - platform: template
    id: plug7_off_hour
    name: "Plug 7 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug7_off_hour_persist) = (int)x;
  - platform: template
    id: plug7_off_minute
    name: "Plug 7 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug7_off_minute_persist) = (int)x;

  - platform: template
    id: plug8_on_hour
    name: "Plug 8 On Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug8_on_hour_persist) = (int)x;
  - platform: template
    id: plug8_on_minute
    name: "Plug 8 On Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug8_on_minute_persist) = (int)x;
  - platform: template
    id: plug8_off_hour
    name: "Plug 8 Off Hour"
    min_value: 1
    max_value: 12
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug8_off_hour_persist) = (int)x;
  - platform: template
    id: plug8_off_minute
    name: "Plug 8 Off Minute"
    min_value: 0
    max_value: 59
    step: 1
    optimistic: true
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug8_off_minute_persist) = (int)x;

select:
  - platform: template
    id: plug1_on_ampm
    name: "Plug 1 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug1_on_ampm_persist) = x;
  - platform: template
    id: plug1_off_ampm
    name: "Plug 1 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug1_off_ampm_persist) = x;

  - platform: template
    id: plug2_on_ampm
    name: "Plug 2 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug2_on_ampm_persist) = x;
  - platform: template
    id: plug2_off_ampm
    name: "Plug 2 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug2_off_ampm_persist) = x;

  - platform: template
    id: plug3_on_ampm
    name: "Plug 3 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug3_on_ampm_persist) = x;
  - platform: template
    id: plug3_off_ampm
    name: "Plug 3 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug3_off_ampm_persist) = x;

  - platform: template
    id: plug4_on_ampm
    name: "Plug 4 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug4_on_ampm_persist) = x;
  - platform: template
    id: plug4_off_ampm
    name: "Plug 4 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug4_off_ampm_persist) = x;

  - platform: template
    id: plug5_on_ampm
    name: "Plug 5 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug5_on_ampm_persist) = x;
  - platform: template
    id: plug5_off_ampm
    name: "Plug 5 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug5_off_ampm_persist) = x;

  - platform: template
    id: plug6_on_ampm
    name: "Plug 6 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug6_on_ampm_persist) = x;
  - platform: template
    id: plug6_off_ampm
    name: "Plug 6 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug6_off_ampm_persist) = x;

  - platform: template
    id: plug7_on_ampm
    name: "Plug 7 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug7_on_ampm_persist) = x;
  - platform: template
    id: plug7_off_ampm
    name: "Plug 7 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug7_off_ampm_persist) = x;

  - platform: template
    id: plug8_on_ampm
    name: "Plug 8 On AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug8_on_ampm_persist) = x;
  - platform: template
    id: plug8_off_ampm
    name: "Plug 8 Off AM/PM"
    optimistic: true
    options: ["AM", "PM"]
    entity_category: "config"
    on_value:
      - lambda: |-
          id(plug8_off_ampm_persist) = x;

display:
  - platform: rpi_dpi_rgb
    id: waveshare_display
    auto_clear_enabled: false
    color_order: RGB
    pclk_frequency: 16MHz
    dimensions:
      width: 800
      height: 480
    de_pin:
      number: 5
    hsync_pin:
      number: 46
      ignore_strapping_warning: true
    vsync_pin:
      number: 3
      ignore_strapping_warning: true
    pclk_pin:
      number: 7
    pclk_inverted: true
    reset_pin:
      ch422g: ch422g_hub
      number: 3
    hsync_back_porch: 8
    hsync_front_porch: 8
    hsync_pulse_width: 4
    vsync_back_porch: 16
    vsync_front_porch: 16
    vsync_pulse_width: 4
    data_pins:
      red:   [1, 2, 42, 41, 40]
      blue:  [14, 38, 18, 17, 10]
      green: [39, 0, 45, 48, 47, 21]

touchscreen:
  - platform: gt911
    id: waveshare_touch
    interrupt_pin: GPIO4
    reset_pin:
      ch422g: ch422g_hub
      number: 1
      mode: OUTPUT

lvgl:
  log_level: INFO
  color_depth: 16
  bg_color: 0x101830

  displays:
    - waveshare_display
  touchscreens:
    - waveshare_touch

  on_ready:
    then:
      - lvgl.page.show:
          id: main_page
      - script.execute: register_activity
      - lambda: |-
          // Set initial clock display ONLY if time is valid
          auto now = id(sntp_time).now();
          if (now.is_valid()) {
            char buf[16];
            int h12 = now.hour % 12;
            if (h12 == 0) h12 = 12;
            bool pm = now.hour >= 12;
            sprintf(buf, "%02d:%02d %s", h12, now.minute, pm ? "PM" : "AM");
            lv_label_set_text(id(lbl_main_time), buf);
            lv_label_set_text(id(lbl_timer1_clock), buf);
            lv_label_set_text(id(lbl_timer2_clock), buf);
            lv_label_set_text(id(lbl_timer3_clock), buf);
            lv_label_set_text(id(lbl_timer4_clock), buf);
            lv_label_set_text(id(lbl_timer5_clock), buf);
            lv_label_set_text(id(lbl_timer6_clock), buf);
            lv_label_set_text(id(lbl_timer7_clock), buf);
            lv_label_set_text(id(lbl_timer8_clock), buf);
          }

          // Restore persisted timer settings ALWAYS (regardless of time validity)
          // Note: Template switches with lambda auto-restore, no publish_state needed
          id(plug1_on_hour).publish_state((int)id(plug1_on_hour_persist));
          id(plug1_on_minute).publish_state((int)id(plug1_on_minute_persist));
          id(plug1_off_hour).publish_state((int)id(plug1_off_hour_persist));
          id(plug1_off_minute).publish_state((int)id(plug1_off_minute_persist));
          id(plug1_on_ampm).publish_state(id(plug1_on_ampm_persist));
          id(plug1_off_ampm).publish_state(id(plug1_off_ampm_persist));
          bool e1 = id(plug1_schedule_persist);
          lv_label_set_text(id(lbl_schedule1_state), e1 ? "Timer: ON" : "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug1_timer), e1 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

          id(plug2_on_hour).publish_state((int)id(plug2_on_hour_persist));
          id(plug2_on_minute).publish_state((int)id(plug2_on_minute_persist));
          id(plug2_off_hour).publish_state((int)id(plug2_off_hour_persist));
          id(plug2_off_minute).publish_state((int)id(plug2_off_minute_persist));
          id(plug2_on_ampm).publish_state(id(plug2_on_ampm_persist));
          id(plug2_off_ampm).publish_state(id(plug2_off_ampm_persist));
          bool e2 = id(plug2_schedule_persist);
          lv_label_set_text(id(lbl_schedule2_state), e2 ? "Timer: ON" : "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug2_timer), e2 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

          id(plug3_on_hour).publish_state((int)id(plug3_on_hour_persist));
          id(plug3_on_minute).publish_state((int)id(plug3_on_minute_persist));
          id(plug3_off_hour).publish_state((int)id(plug3_off_hour_persist));
          id(plug3_off_minute).publish_state((int)id(plug3_off_minute_persist));
          id(plug3_on_ampm).publish_state(id(plug3_on_ampm_persist));
          id(plug3_off_ampm).publish_state(id(plug3_off_ampm_persist));
          bool e3 = id(plug3_schedule_persist);
          lv_label_set_text(id(lbl_schedule3_state), e3 ? "Timer: ON" : "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug3_timer), e3 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

          id(plug4_on_hour).publish_state((int)id(plug4_on_hour_persist));
          id(plug4_on_minute).publish_state((int)id(plug4_on_minute_persist));
          id(plug4_off_hour).publish_state((int)id(plug4_off_hour_persist));
          id(plug4_off_minute).publish_state((int)id(plug4_off_minute_persist));
          id(plug4_on_ampm).publish_state(id(plug4_on_ampm_persist));
          id(plug4_off_ampm).publish_state(id(plug4_off_ampm_persist));
          bool e4 = id(plug4_schedule_persist);
          lv_label_set_text(id(lbl_schedule4_state), e4 ? "Timer: ON" : "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug4_timer), e4 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

          id(plug5_on_hour).publish_state((int)id(plug5_on_hour_persist));
          id(plug5_on_minute).publish_state((int)id(plug5_on_minute_persist));
          id(plug5_off_hour).publish_state((int)id(plug5_off_hour_persist));
          id(plug5_off_minute).publish_state((int)id(plug5_off_minute_persist));
          id(plug5_on_ampm).publish_state(id(plug5_on_ampm_persist));
          id(plug5_off_ampm).publish_state(id(plug5_off_ampm_persist));
          bool e5 = id(plug5_schedule_persist);
          lv_label_set_text(id(lbl_schedule5_state), e5 ? "Timer: ON" : "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug5_timer), e5 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

          id(plug6_on_hour).publish_state((int)id(plug6_on_hour_persist));
          id(plug6_on_minute).publish_state((int)id(plug6_on_minute_persist));
          id(plug6_off_hour).publish_state((int)id(plug6_off_hour_persist));
          id(plug6_off_minute).publish_state((int)id(plug6_off_minute_persist));
          id(plug6_on_ampm).publish_state(id(plug6_on_ampm_persist));
          id(plug6_off_ampm).publish_state(id(plug6_off_ampm_persist));
          bool e6 = id(plug6_schedule_persist);
          lv_label_set_text(id(lbl_schedule6_state), e6 ? "Timer: ON" : "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug6_timer), e6 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

          id(plug7_on_hour).publish_state((int)id(plug7_on_hour_persist));
          id(plug7_on_minute).publish_state((int)id(plug7_on_minute_persist));
          id(plug7_off_hour).publish_state((int)id(plug7_off_hour_persist));
          id(plug7_off_minute).publish_state((int)id(plug7_off_minute_persist));
          id(plug7_on_ampm).publish_state(id(plug7_on_ampm_persist));
          id(plug7_off_ampm).publish_state(id(plug7_off_ampm_persist));
          bool e7 = id(plug7_schedule_persist);
          lv_label_set_text(id(lbl_schedule7_state), e7 ? "Timer: ON" : "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug7_timer), e7 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

          id(plug8_on_hour).publish_state((int)id(plug8_on_hour_persist));
          id(plug8_on_minute).publish_state((int)id(plug8_on_minute_persist));
          id(plug8_off_hour).publish_state((int)id(plug8_off_hour_persist));
          id(plug8_off_minute).publish_state((int)id(plug8_off_minute_persist));
          id(plug8_on_ampm).publish_state(id(plug8_on_ampm_persist));
          id(plug8_off_ampm).publish_state(id(plug8_off_ampm_persist));
          bool e8 = id(plug8_schedule_persist);
          lv_label_set_text(id(lbl_schedule8_state), e8 ? "Timer: ON" : "Timer: OFF");
          lv_obj_set_style_bg_color(id(btn_plug8_timer), e8 ? lv_color_hex(0x228B22) : lv_color_hex(0x444444), LV_PART_MAIN);

          // Apply modern styling to all buttons (rounded corners + shadows)
          lv_obj_t* buttons[] = {
            id(btn_plug1), id(btn_plug1_timer),
            id(btn_plug2), id(btn_plug2_timer),
            id(btn_plug3), id(btn_plug3_timer),
            id(btn_plug4), id(btn_plug4_timer),
            id(btn_plug5), id(btn_plug5_timer),
            id(btn_plug6), id(btn_plug6_timer),
            id(btn_plug7), id(btn_plug7_timer),
            id(btn_plug8), id(btn_plug8_timer),
            id(btn_bl_auto), id(btn_bl_on)
          };
          for (auto btn : buttons) {
            lv_obj_set_style_radius(btn, 15, LV_PART_MAIN);
            lv_obj_set_style_shadow_width(btn, 8, LV_PART_MAIN);
            lv_obj_set_style_shadow_color(btn, lv_color_hex(0x000000), LV_PART_MAIN);
            lv_obj_set_style_shadow_ofs_y(btn, 4, LV_PART_MAIN);
            lv_obj_set_style_shadow_ofs_x(btn, 0, LV_PART_MAIN);
            lv_obj_set_style_border_width(btn, 0, LV_PART_MAIN);
          }
      - script.execute: startup_check_plugs

  pages:
    - id: main_page
      widgets:
        - obj:
            id: main_bg
            x: 0
            y: 0
            width: 800
            height: 480
            bg_color: 0x0A1929

        # Modern header bar
        - obj:
            x: 0
            y: 0
            width: 800
            height: 55
            bg_color: 0x1E3A5F
            border_width: 0
            bg_grad_dir: VER
            bg_grad_color: 0x0F2847

        - label:
            id: lbl_main_title
            align: top_mid
            y: 15
            text: "Smart-Home Controller"
            text_font: font_large
            text_color: 0xFFFFFF

        # PLUG 1
        - button:
            id: btn_plug1
            x: 20
            y: 70
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: !lambda return id(plug1_name).c_str();, align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                    url: !lambda |-
                      return std::string("http://") + id(plug1_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug1_update_state

        - button:
            id: btn_plug1_timer
            x: 260
            y: 70
            width: 110
            height: 60
            bg_color: 0x444444
            widgets: [{ label: { text: "Timer", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: plug1_timer_page

        # PLUG 5
        - button:
            id: btn_plug5
            x: 410
            y: 70
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: !lambda return id(plug5_name).c_str();, align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                    url: !lambda |-
                      return std::string("http://") + id(plug5_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug5_update_state

        - button:
            id: btn_plug5_timer
            x: 650
            y: 70
            width: 110
            height: 60
            bg_color: 0x444444
            widgets: [{ label: { text: "Timer", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: plug5_timer_page

        # Row 2: PLUG 2 & PLUG 6
        - button:
            id: btn_plug2
            x: 20
            y: 150
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: !lambda return id(plug2_name).c_str();, align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                    url: !lambda |-
                      return std::string("http://") + id(plug2_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug2_update_state

        - button:
            id: btn_plug2_timer
            x: 260
            y: 150
            width: 110
            height: 60
            bg_color: 0x444444
            widgets: [{ label: { text: "Timer", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: plug2_timer_page

        - button:
            id: btn_plug6
            x: 410
            y: 150
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: !lambda return id(plug6_name).c_str();, align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                    url: !lambda |-
                      return std::string("http://") + id(plug6_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug6_update_state

        - button:
            id: btn_plug6_timer
            x: 650
            y: 150
            width: 110
            height: 60
            bg_color: 0x444444
            widgets: [{ label: { text: "Timer", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: plug6_timer_page

        # Row 3: PLUG 3 & PLUG 7
        - button:
            id: btn_plug3
            x: 20
            y: 230
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: !lambda return id(plug3_name).c_str();, align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                    url: !lambda |-
                      return std::string("http://") + id(plug3_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug3_update_state

        - button:
            id: btn_plug3_timer
            x: 260
            y: 230
            width: 110
            height: 60
            bg_color: 0x444444
            widgets: [{ label: { text: "Timer", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: plug3_timer_page

        - button:
            id: btn_plug7
            x: 410
            y: 230
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: !lambda return id(plug7_name).c_str();, align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                    url: !lambda |-
                      return std::string("http://") + id(plug7_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug7_update_state

        - button:
            id: btn_plug7_timer
            x: 650
            y: 230
            width: 110
            height: 60
            bg_color: 0x444444
            widgets: [{ label: { text: "Timer", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: plug7_timer_page

        # Row 4: PLUG 4 & PLUG 8
        - button:
            id: btn_plug4
            x: 20
            y: 310
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: !lambda return id(plug4_name).c_str();, align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - http_request.post:
                    url: !lambda |-
                      return std::string("http://") + id(plug4_ip_str) + std::string("/switch/kauf_plug/toggle");
                - delay: 500ms
                - script.execute: plug4_update_state

        - button:
            id: btn_plug4_timer
            x: 260
            y: 310
            width: 110
            height: 60
            bg_color: 0x444444
            widgets: [{ label: { text: "Timer", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: plug4_timer_page

        - button:
            id: btn_plug8
            x: 410
            y: 310
            width: 230
            height: 60
            bg_color: 0xFF0000
            widgets: [{ label: { text: !lambda return id(plug8_name).c_str();, align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - script.execute: toggle_plug8_device

        - button:
            id: btn_plug8_timer
            x: 650
            y: 310
            width: 110
            height: 60
            bg_color: 0x444444
            widgets: [{ label: { text: "Timer", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: plug8_timer_page

        # Backlight controls
        - label:
            x: 21
            y: 399
            text: "Backlight:"
            text_font: font_small
            text_color: 0xFFFFFF

        - button:
            id: btn_bl_auto
            x: 130
            y: 386
            width: 120
            height: 50
            bg_color: 0x228B22
            widgets: [{ label: { text: "AUTO (5m)", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    id(bl_mode) = 0;
                    lv_obj_set_style_bg_color(id(btn_bl_auto), lv_color_hex(0x228B22), LV_PART_MAIN);
                    lv_obj_set_style_bg_color(id(btn_bl_on),   lv_color_hex(0x444444), LV_PART_MAIN);

        - button:
            id: btn_bl_on
            x: 260
            y: 386
            width: 110
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "ON", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    id(bl_mode) = 1;
                    id(lcd_backlight_sw).turn_on();
                    auto call = id(lcdbacklight).turn_on();
                    float bri = id(bl_level) / 100.0f;
                    call.set_brightness(bri);
                    call.perform();
                    lv_obj_set_style_bg_color(id(btn_bl_on),   lv_color_hex(0x228B22), LV_PART_MAIN);
                    lv_obj_set_style_bg_color(id(btn_bl_auto), lv_color_hex(0x444444), LV_PART_MAIN);
                - script.execute: register_activity

        # Accent bar at bottom for visual polish
        - obj:
            x: 0
            y: 450
            width: 800
            height: 30
            bg_color: 0x1E3A5F
            border_width: 0
            bg_grad_dir: HOR
            bg_grad_color: 0x2E5A8F

        # Main page clock
        - label:
            id: lbl_main_time
            x: 655
            y: 393
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

    # TIMER PAGES - Plug 1
    - id: plug1_timer_page
      widgets:
        - label:
            id: lbl_timer1_title
            x: 20
            y: 10
            text: !lambda |-
                return id(plug1_name) + std::string(" TIMER");
            text_font: font_large
            text_color: 0xFFFFFF

        - label:
            id: lbl_timer1_ip
            x: 20
            y: 45
            text: !lambda |-
                return ("IP: " + id(plug1_ip_str)).c_str();
            text_font: font_small
            text_color: 0x00FF00

        - label:
            id: lbl_timer1_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer1_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule1_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule1_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Timer: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug1_schedule_enabled).state;
                    if (cur) {
                      id(plug1_schedule_enabled).turn_off();
                    } else {
                      id(plug1_schedule_enabled).turn_on();
                    }
                - script.execute: save_timer_settings

        - label:
            id: lbl1_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn1_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug1_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug1_on_hour_persist) = h;
                    id(plug1_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl1_on_time
                    text: !lambda |-
                      int h = (int) id(plug1_on_hour).state;
                      int m = (int) id(plug1_on_minute).state;
                      auto ampm = id(plug1_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn1_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug1_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug1_on_hour_persist) = h;
                    id(plug1_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl1_on_time
                    text: !lambda |-
                      int h = (int) id(plug1_on_hour).state;
                      int m = (int) id(plug1_on_minute).state;
                      auto ampm = id(plug1_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn1_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug1_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug1_on_minute_persist) = m;
                    id(plug1_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl1_on_time
                    text: !lambda |-
                      int h = (int) id(plug1_on_hour).state;
                      int m = (int) id(plug1_on_minute).state;
                      auto ampm = id(plug1_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn1_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug1_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug1_on_minute_persist) = m;
                    id(plug1_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl1_on_time
                    text: !lambda |-
                      int h = (int) id(plug1_on_hour).state;
                      int m = (int) id(plug1_on_minute).state;
                      auto ampm = id(plug1_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn1_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl1_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug1_on_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug1_on_ampm_persist) = new_val;
                    id(plug1_on_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl1_on_ampm
                    text: !lambda |-
                      return id(plug1_on_ampm).state;
                - lvgl.label.update:
                    id: lbl1_on_time
                    text: !lambda |-
                      int h = (int) id(plug1_on_hour).state;
                      int m = (int) id(plug1_on_minute).state;
                      auto ampm = id(plug1_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - label:
            id: lbl1_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn1_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug1_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug1_off_hour_persist) = h;
                    id(plug1_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl1_off_time
                    text: !lambda |-
                      int h = (int) id(plug1_off_hour).state;
                      int m = (int) id(plug1_off_minute).state;
                      auto ampm = id(plug1_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn1_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug1_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug1_off_hour_persist) = h;
                    id(plug1_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl1_off_time
                    text: !lambda |-
                      int h = (int) id(plug1_off_hour).state;
                      int m = (int) id(plug1_off_minute).state;
                      auto ampm = id(plug1_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn1_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug1_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug1_off_minute_persist) = m;
                    id(plug1_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl1_off_time
                    text: !lambda |-
                      int h = (int) id(plug1_off_hour).state;
                      int m = (int) id(plug1_off_minute).state;
                      auto ampm = id(plug1_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn1_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug1_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug1_off_minute_persist) = m;
                    id(plug1_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl1_off_time
                    text: !lambda |-
                      int h = (int) id(plug1_off_hour).state;
                      int m = (int) id(plug1_off_minute).state;
                      auto ampm = id(plug1_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn1_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl1_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug1_off_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug1_off_ampm_persist) = new_val;
                    id(plug1_off_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl1_off_ampm
                    text: !lambda |-
                      return id(plug1_off_ampm).state;
                - lvgl.label.update:
                    id: lbl1_off_time
                    text: !lambda |-
                      int h = (int) id(plug1_off_hour).state;
                      int m = (int) id(plug1_off_minute).state;
                      auto ampm = id(plug1_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings


    # TIMER PAGES - Plug 2
    - id: plug2_timer_page
      widgets:
        - label:
            id: lbl_timer2_title
            x: 20
            y: 10
            text: !lambda |- 
                return id(plug2_name) + std::string(" TIMER");
            text_font: font_large
            text_color: 0xFFFFFF

        - label:
            id: lbl_timer2_ip
            x: 20
            y: 45
            text: !lambda |-
                return ("IP: " + id(plug2_ip_str)).c_str();
            text_font: font_small
            text_color: 0x00FF00

        - label:
            id: lbl_timer2_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer2_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule2_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule2_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Timer: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug2_schedule_enabled).state;
                    if (cur) {
                      id(plug2_schedule_enabled).turn_off();
                    } else {
                      id(plug2_schedule_enabled).turn_on();
                    }

        - label:
            id: lbl2_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn2_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug2_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug2_on_hour_persist) = h;
                    id(plug2_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl2_on_time
                    text: !lambda |-
                      int h = (int) id(plug2_on_hour).state;
                      int m = (int) id(plug2_on_minute).state;
                      auto ampm = id(plug2_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn2_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug2_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug2_on_hour_persist) = h;
                    id(plug2_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl2_on_time
                    text: !lambda |-
                      int h = (int) id(plug2_on_hour).state;
                      int m = (int) id(plug2_on_minute).state;
                      auto ampm = id(plug2_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn2_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug2_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug2_on_minute_persist) = m;
                    id(plug2_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl2_on_time
                    text: !lambda |-
                      int h = (int) id(plug2_on_hour).state;
                      int m = (int) id(plug2_on_minute).state;
                      auto ampm = id(plug2_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn2_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug2_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug2_on_minute_persist) = m;
                    id(plug2_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl2_on_time
                    text: !lambda |-
                      int h = (int) id(plug2_on_hour).state;
                      int m = (int) id(plug2_on_minute).state;
                      auto ampm = id(plug2_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn2_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl2_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug2_on_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug2_on_ampm_persist) = new_val;
                    id(plug2_on_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl2_on_ampm
                    text: !lambda |-
                      return id(plug2_on_ampm).state;
                - lvgl.label.update:
                    id: lbl2_on_time
                    text: !lambda |-
                      int h = (int) id(plug2_on_hour).state;
                      int m = (int) id(plug2_on_minute).state;
                      auto ampm = id(plug2_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - label:
            id: lbl2_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn2_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug2_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug2_off_hour_persist) = h;
                    id(plug2_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl2_off_time
                    text: !lambda |-
                      int h = (int) id(plug2_off_hour).state;
                      int m = (int) id(plug2_off_minute).state;
                      auto ampm = id(plug2_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn2_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug2_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug2_off_hour_persist) = h;
                    id(plug2_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl2_off_time
                    text: !lambda |-
                      int h = (int) id(plug2_off_hour).state;
                      int m = (int) id(plug2_off_minute).state;
                      auto ampm = id(plug2_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn2_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug2_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug2_off_minute_persist) = m;
                    id(plug2_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl2_off_time
                    text: !lambda |-
                      int h = (int) id(plug2_off_hour).state;
                      int m = (int) id(plug2_off_minute).state;
                      auto ampm = id(plug2_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn2_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug2_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug2_off_minute_persist) = m;
                    id(plug2_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl2_off_time
                    text: !lambda |-
                      int h = (int) id(plug2_off_hour).state;
                      int m = (int) id(plug2_off_minute).state;
                      auto ampm = id(plug2_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn2_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl2_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug2_off_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug2_off_ampm_persist) = new_val;
                    id(plug2_off_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl2_off_ampm
                    text: !lambda |-
                      return id(plug2_off_ampm).state;
                - lvgl.label.update:
                    id: lbl2_off_time
                    text: !lambda |-
                      int h = (int) id(plug2_off_hour).state;
                      int m = (int) id(plug2_off_minute).state;
                      auto ampm = id(plug2_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

    # TIMER PAGES - Plug 3
    - id: plug3_timer_page
      widgets:
        - label:
            id: lbl_timer3_title
            x: 20
            y: 10
            text: !lambda |- 
                return id(plug3_name) + std::string(" TIMER");
            text_font: font_large
            text_color: 0xFFFFFF

        - label:
            id: lbl_timer3_ip
            x: 20
            y: 45
            text: !lambda |-
                return ("IP: " + id(plug3_ip_str)).c_str();
            text_font: font_small
            text_color: 0x00FF00

        - label:
            id: lbl_timer3_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer3_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule3_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule3_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Timer: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug3_schedule_enabled).state;
                    if (cur) {
                      id(plug3_schedule_enabled).turn_off();
                    } else {
                      id(plug3_schedule_enabled).turn_on();
                    }

        - label:
            id: lbl3_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn3_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug3_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug3_on_hour_persist) = h;
                    id(plug3_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl3_on_time
                    text: !lambda |-
                      int h = (int) id(plug3_on_hour).state;
                      int m = (int) id(plug3_on_minute).state;
                      auto ampm = id(plug3_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn3_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug3_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug3_on_hour_persist) = h;
                    id(plug3_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl3_on_time
                    text: !lambda |-
                      int h = (int) id(plug3_on_hour).state;
                      int m = (int) id(plug3_on_minute).state;
                      auto ampm = id(plug3_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn3_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug3_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug3_on_minute_persist) = m;
                    id(plug3_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl3_on_time
                    text: !lambda |-
                      int h = (int) id(plug3_on_hour).state;
                      int m = (int) id(plug3_on_minute).state;
                      auto ampm = id(plug3_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn3_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug3_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug3_on_minute_persist) = m;
                    id(plug3_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl3_on_time
                    text: !lambda |-
                      int h = (int) id(plug3_on_hour).state;
                      int m = (int) id(plug3_on_minute).state;
                      auto ampm = id(plug3_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn3_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl3_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug3_on_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug3_on_ampm_persist) = new_val;
                    id(plug3_on_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl3_on_ampm
                    text: !lambda |-
                      return id(plug3_on_ampm).state;
                - lvgl.label.update:
                    id: lbl3_on_time
                    text: !lambda |-
                      int h = (int) id(plug3_on_hour).state;
                      int m = (int) id(plug3_on_minute).state;
                      auto ampm = id(plug3_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - label:
            id: lbl3_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn3_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug3_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug3_off_hour_persist) = h;
                    id(plug3_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl3_off_time
                    text: !lambda |-
                      int h = (int) id(plug3_off_hour).state;
                      int m = (int) id(plug3_off_minute).state;
                      auto ampm = id(plug3_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn3_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug3_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug3_off_hour_persist) = h;
                    id(plug3_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl3_off_time
                    text: !lambda |-
                      int h = (int) id(plug3_off_hour).state;
                      int m = (int) id(plug3_off_minute).state;
                      auto ampm = id(plug3_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn3_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug3_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug3_off_minute_persist) = m;
                    id(plug3_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl3_off_time
                    text: !lambda |-
                      int h = (int) id(plug3_off_hour).state;
                      int m = (int) id(plug3_off_minute).state;
                      auto ampm = id(plug3_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn3_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug3_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug3_off_minute_persist) = m;
                    id(plug3_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl3_off_time
                    text: !lambda |-
                      int h = (int) id(plug3_off_hour).state;
                      int m = (int) id(plug3_off_minute).state;
                      auto ampm = id(plug3_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn3_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl3_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug3_off_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug3_off_ampm_persist) = new_val;
                    id(plug3_off_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl3_off_ampm
                    text: !lambda |-
                      return id(plug3_off_ampm).state;
                - lvgl.label.update:
                    id: lbl3_off_time
                    text: !lambda |-
                      int h = (int) id(plug3_off_hour).state;
                      int m = (int) id(plug3_off_minute).state;
                      auto ampm = id(plug3_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

    # TIMER PAGES - Plug 4
    - id: plug4_timer_page
      widgets:
        - label:
            id: lbl_timer4_title
            x: 20
            y: 10
            text: !lambda |- 
                return id(plug4_name) + std::string(" TIMER");
            text_font: font_large
            text_color: 0xFFFFFF

        - label:
            id: lbl_timer4_ip
            x: 20
            y: 45
            text: !lambda |-
                return ("IP: " + id(plug4_ip_str)).c_str();
            text_font: font_small
            text_color: 0x00FF00

        - label:
            id: lbl_timer4_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer4_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule4_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule4_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Timer: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug4_schedule_enabled).state;
                    if (cur) {
                      id(plug4_schedule_enabled).turn_off();
                    } else {
                      id(plug4_schedule_enabled).turn_on();
                    }

        - label:
            id: lbl4_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn4_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug4_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug4_on_hour_persist) = h;
                    id(plug4_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl4_on_time
                    text: !lambda |-
                      int h = (int) id(plug4_on_hour).state;
                      int m = (int) id(plug4_on_minute).state;
                      auto ampm = id(plug4_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn4_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug4_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug4_on_hour_persist) = h;
                    id(plug4_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl4_on_time
                    text: !lambda |-
                      int h = (int) id(plug4_on_hour).state;
                      int m = (int) id(plug4_on_minute).state;
                      auto ampm = id(plug4_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn4_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug4_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug4_on_minute_persist) = m;
                    id(plug4_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl4_on_time
                    text: !lambda |-
                      int h = (int) id(plug4_on_hour).state;
                      int m = (int) id(plug4_on_minute).state;
                      auto ampm = id(plug4_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn4_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug4_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug4_on_minute_persist) = m;
                    id(plug4_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl4_on_time
                    text: !lambda |-
                      int h = (int) id(plug4_on_hour).state;
                      int m = (int) id(plug4_on_minute).state;
                      auto ampm = id(plug4_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn4_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl4_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug4_on_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug4_on_ampm_persist) = new_val;
                    id(plug4_on_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl4_on_ampm
                    text: !lambda |-
                      return id(plug4_on_ampm).state;
                - lvgl.label.update:
                    id: lbl4_on_time
                    text: !lambda |-
                      int h = (int) id(plug4_on_hour).state;
                      int m = (int) id(plug4_on_minute).state;
                      auto ampm = id(plug4_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - label:
            id: lbl4_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn4_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug4_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug4_off_hour_persist) = h;
                    id(plug4_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl4_off_time
                    text: !lambda |-
                      int h = (int) id(plug4_off_hour).state;
                      int m = (int) id(plug4_off_minute).state;
                      auto ampm = id(plug4_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn4_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug4_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug4_off_hour_persist) = h;
                    id(plug4_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl4_off_time
                    text: !lambda |-
                      int h = (int) id(plug4_off_hour).state;
                      int m = (int) id(plug4_off_minute).state;
                      auto ampm = id(plug4_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn4_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug4_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug4_off_minute_persist) = m;
                    id(plug4_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl4_off_time
                    text: !lambda |-
                      int h = (int) id(plug4_off_hour).state;
                      int m = (int) id(plug4_off_minute).state;
                      auto ampm = id(plug4_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn4_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug4_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug4_off_minute_persist) = m;
                    id(plug4_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl4_off_time
                    text: !lambda |-
                      int h = (int) id(plug4_off_hour).state;
                      int m = (int) id(plug4_off_minute).state;
                      auto ampm = id(plug4_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn4_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl4_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug4_off_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug4_off_ampm_persist) = new_val;
                    id(plug4_off_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl4_off_ampm
                    text: !lambda |-
                      return id(plug4_off_ampm).state;
                - lvgl.label.update:
                    id: lbl4_off_time
                    text: !lambda |-
                      int h = (int) id(plug4_off_hour).state;
                      int m = (int) id(plug4_off_minute).state;
                      auto ampm = id(plug4_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

    # TIMER PAGES - Plug 5
    - id: plug5_timer_page
      widgets:
        - label:
            id: lbl_timer5_title
            x: 20
            y: 10
            text: !lambda |- 
                return id(plug5_name) + std::string(" TIMER");
            text_font: font_large
            text_color: 0xFFFFFF

        - label:
            id: lbl_timer5_ip
            x: 20
            y: 45
            text: !lambda |-
                return ("IP: " + id(plug5_ip_str)).c_str();
            text_font: font_small
            text_color: 0x00FF00

        - label:
            id: lbl_timer5_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer5_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule5_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule5_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Timer: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug5_schedule_enabled).state;
                    if (cur) {
                      id(plug5_schedule_enabled).turn_off();
                    } else {
                      id(plug5_schedule_enabled).turn_on();
                    }

        - label:
            id: lbl5_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn5_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug5_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug5_on_hour_persist) = h;
                    id(plug5_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl5_on_time
                    text: !lambda |-
                      int h = (int) id(plug5_on_hour).state;
                      int m = (int) id(plug5_on_minute).state;
                      auto ampm = id(plug5_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn5_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug5_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug5_on_hour_persist) = h;
                    id(plug5_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl5_on_time
                    text: !lambda |-
                      int h = (int) id(plug5_on_hour).state;
                      int m = (int) id(plug5_on_minute).state;
                      auto ampm = id(plug5_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn5_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug5_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug5_on_minute_persist) = m;
                    id(plug5_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl5_on_time
                    text: !lambda |-
                      int h = (int) id(plug5_on_hour).state;
                      int m = (int) id(plug5_on_minute).state;
                      auto ampm = id(plug5_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn5_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug5_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug5_on_minute_persist) = m;
                    id(plug5_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl5_on_time
                    text: !lambda |-
                      int h = (int) id(plug5_on_hour).state;
                      int m = (int) id(plug5_on_minute).state;
                      auto ampm = id(plug5_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn5_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl5_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug5_on_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug5_on_ampm_persist) = new_val;
                    id(plug5_on_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl5_on_ampm
                    text: !lambda |-
                      return id(plug5_on_ampm).state;
                - lvgl.label.update:
                    id: lbl5_on_time
                    text: !lambda |-
                      int h = (int) id(plug5_on_hour).state;
                      int m = (int) id(plug5_on_minute).state;
                      auto ampm = id(plug5_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - label:
            id: lbl5_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn5_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug5_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug5_off_hour_persist) = h;
                    id(plug5_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl5_off_time
                    text: !lambda |-
                      int h = (int) id(plug5_off_hour).state;
                      int m = (int) id(plug5_off_minute).state;
                      auto ampm = id(plug5_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn5_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug5_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug5_off_hour_persist) = h;
                    id(plug5_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl5_off_time
                    text: !lambda |-
                      int h = (int) id(plug5_off_hour).state;
                      int m = (int) id(plug5_off_minute).state;
                      auto ampm = id(plug5_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn5_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug5_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug5_off_minute_persist) = m;
                    id(plug5_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl5_off_time
                    text: !lambda |-
                      int h = (int) id(plug5_off_hour).state;
                      int m = (int) id(plug5_off_minute).state;
                      auto ampm = id(plug5_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn5_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug5_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug5_off_minute_persist) = m;
                    id(plug5_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl5_off_time
                    text: !lambda |-
                      int h = (int) id(plug5_off_hour).state;
                      int m = (int) id(plug5_off_minute).state;
                      auto ampm = id(plug5_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn5_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl5_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug5_off_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug5_off_ampm_persist) = new_val;
                    id(plug5_off_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl5_off_ampm
                    text: !lambda |-
                      return id(plug5_off_ampm).state;
                - lvgl.label.update:
                    id: lbl5_off_time
                    text: !lambda |-
                      int h = (int) id(plug5_off_hour).state;
                      int m = (int) id(plug5_off_minute).state;
                      auto ampm = id(plug5_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

    # TIMER PAGES - Plug 6
    - id: plug6_timer_page
      widgets:
        - label:
            id: lbl_timer6_title
            x: 20
            y: 10
            text: !lambda |- 
                return id(plug6_name) + std::string(" TIMER");
            text_font: font_large
            text_color: 0xFFFFFF

        - label:
            id: lbl_timer6_ip
            x: 20
            y: 45
            text: !lambda |-
                return ("IP: " + id(plug6_ip_str)).c_str();
            text_font: font_small
            text_color: 0x00FF00

        - label:
            id: lbl_timer6_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer6_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule6_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule6_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Timer: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug6_schedule_enabled).state;
                    if (cur) {
                      id(plug6_schedule_enabled).turn_off();
                    } else {
                      id(plug6_schedule_enabled).turn_on();
                    }

        - label:
            id: lbl6_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn6_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug6_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug6_on_hour_persist) = h;
                    id(plug6_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl6_on_time
                    text: !lambda |-
                      int h = (int) id(plug6_on_hour).state;
                      int m = (int) id(plug6_on_minute).state;
                      auto ampm = id(plug6_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn6_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug6_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug6_on_hour_persist) = h;
                    id(plug6_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl6_on_time
                    text: !lambda |-
                      int h = (int) id(plug6_on_hour).state;
                      int m = (int) id(plug6_on_minute).state;
                      auto ampm = id(plug6_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn6_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug6_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug6_on_minute_persist) = m;
                    id(plug6_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl6_on_time
                    text: !lambda |-
                      int h = (int) id(plug6_on_hour).state;
                      int m = (int) id(plug6_on_minute).state;
                      auto ampm = id(plug6_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn6_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug6_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug6_on_minute_persist) = m;
                    id(plug6_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl6_on_time
                    text: !lambda |-
                      int h = (int) id(plug6_on_hour).state;
                      int m = (int) id(plug6_on_minute).state;
                      auto ampm = id(plug6_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn6_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl6_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug6_on_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug6_on_ampm_persist) = new_val;
                    id(plug6_on_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl6_on_ampm
                    text: !lambda |-
                      return id(plug6_on_ampm).state;
                - lvgl.label.update:
                    id: lbl6_on_time
                    text: !lambda |-
                      int h = (int) id(plug6_on_hour).state;
                      int m = (int) id(plug6_on_minute).state;
                      auto ampm = id(plug6_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - label:
            id: lbl6_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn6_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug6_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug6_off_hour_persist) = h;
                    id(plug6_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl6_off_time
                    text: !lambda |-
                      int h = (int) id(plug6_off_hour).state;
                      int m = (int) id(plug6_off_minute).state;
                      auto ampm = id(plug6_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn6_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug6_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug6_off_hour_persist) = h;
                    id(plug6_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl6_off_time
                    text: !lambda |-
                      int h = (int) id(plug6_off_hour).state;
                      int m = (int) id(plug6_off_minute).state;
                      auto ampm = id(plug6_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn6_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug6_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug6_off_minute_persist) = m;
                    id(plug6_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl6_off_time
                    text: !lambda |-
                      int h = (int) id(plug6_off_hour).state;
                      int m = (int) id(plug6_off_minute).state;
                      auto ampm = id(plug6_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn6_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug6_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug6_off_minute_persist) = m;
                    id(plug6_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl6_off_time
                    text: !lambda |-
                      int h = (int) id(plug6_off_hour).state;
                      int m = (int) id(plug6_off_minute).state;
                      auto ampm = id(plug6_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn6_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl6_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug6_off_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug6_off_ampm_persist) = new_val;
                    id(plug6_off_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl6_off_ampm
                    text: !lambda |-
                      return id(plug6_off_ampm).state;
                - lvgl.label.update:
                    id: lbl6_off_time
                    text: !lambda |-
                      int h = (int) id(plug6_off_hour).state;
                      int m = (int) id(plug6_off_minute).state;
                      auto ampm = id(plug6_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

    # TIMER PAGES - Plug 7
    - id: plug7_timer_page
      widgets:
        - label:
            id: lbl_timer7_title
            x: 20
            y: 10
            text: !lambda |- 
                return id(plug7_name) + std::string(" TIMER");
            text_font: font_large
            text_color: 0xFFFFFF

        - label:
            id: lbl_timer7_ip
            x: 20
            y: 45
            text: !lambda |-
                return ("IP: " + id(plug7_ip_str)).c_str();
            text_font: font_small
            text_color: 0x00FF00

        - label:
            id: lbl_timer7_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer7_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule7_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule7_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Timer: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug7_schedule_enabled).state;
                    if (cur) {
                      id(plug7_schedule_enabled).turn_off();
                    } else {
                      id(plug7_schedule_enabled).turn_on();
                    }

        - label:
            id: lbl7_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn7_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug7_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug7_on_hour_persist) = h;
                    id(plug7_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl7_on_time
                    text: !lambda |-
                      int h = (int) id(plug7_on_hour).state;
                      int m = (int) id(plug7_on_minute).state;
                      auto ampm = id(plug7_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn7_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug7_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug7_on_hour_persist) = h;
                    id(plug7_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl7_on_time
                    text: !lambda |-
                      int h = (int) id(plug7_on_hour).state;
                      int m = (int) id(plug7_on_minute).state;
                      auto ampm = id(plug7_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn7_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug7_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug7_on_minute_persist) = m;
                    id(plug7_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl7_on_time
                    text: !lambda |-
                      int h = (int) id(plug7_on_hour).state;
                      int m = (int) id(plug7_on_minute).state;
                      auto ampm = id(plug7_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn7_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug7_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug7_on_minute_persist) = m;
                    id(plug7_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl7_on_time
                    text: !lambda |-
                      int h = (int) id(plug7_on_hour).state;
                      int m = (int) id(plug7_on_minute).state;
                      auto ampm = id(plug7_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn7_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl7_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug7_on_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug7_on_ampm_persist) = new_val;
                    id(plug7_on_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl7_on_ampm
                    text: !lambda |-
                      return id(plug7_on_ampm).state;
                - lvgl.label.update:
                    id: lbl7_on_time
                    text: !lambda |-
                      int h = (int) id(plug7_on_hour).state;
                      int m = (int) id(plug7_on_minute).state;
                      auto ampm = id(plug7_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - label:
            id: lbl7_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn7_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug7_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug7_off_hour_persist) = h;
                    id(plug7_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl7_off_time
                    text: !lambda |-
                      int h = (int) id(plug7_off_hour).state;
                      int m = (int) id(plug7_off_minute).state;
                      auto ampm = id(plug7_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn7_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug7_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug7_off_hour_persist) = h;
                    id(plug7_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl7_off_time
                    text: !lambda |-
                      int h = (int) id(plug7_off_hour).state;
                      int m = (int) id(plug7_off_minute).state;
                      auto ampm = id(plug7_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn7_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug7_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug7_off_minute_persist) = m;
                    id(plug7_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl7_off_time
                    text: !lambda |-
                      int h = (int) id(plug7_off_hour).state;
                      int m = (int) id(plug7_off_minute).state;
                      auto ampm = id(plug7_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn7_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug7_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug7_off_minute_persist) = m;
                    id(plug7_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl7_off_time
                    text: !lambda |-
                      int h = (int) id(plug7_off_hour).state;
                      int m = (int) id(plug7_off_minute).state;
                      auto ampm = id(plug7_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn7_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl7_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug7_off_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug7_off_ampm_persist) = new_val;
                    id(plug7_off_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl7_off_ampm
                    text: !lambda |-
                      return id(plug7_off_ampm).state;
                - lvgl.label.update:
                    id: lbl7_off_time
                    text: !lambda |-
                      int h = (int) id(plug7_off_hour).state;
                      int m = (int) id(plug7_off_minute).state;
                      auto ampm = id(plug7_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

    # TIMER PAGES - Plug 8
    - id: plug8_timer_page
      widgets:
        - label:
            id: lbl_timer8_title
            x: 20
            y: 10
            text: !lambda |- 
                return id(plug8_name) + std::string(" TIMER");
            text_font: font_large
            text_color: 0xFFFFFF

        - label:
            id: lbl_timer8_ip
            x: 20
            y: 45
            text: !lambda |-
                return ("IP: " + id(plug8_ip_str)).c_str();
            text_font: font_small
            text_color: 0x00FF00

        - label:
            id: lbl_timer8_clock
            x: 520
            y: 20
            text: "--:-- --"
            text_font: font_large
            text_color: 0xFFFFFF

        - button:
            id: btn_timer8_back
            x: 650
            y: 10
            width: 130
            height: 60
            bg_color: 0x333333
            widgets: [{ label: { text: "BACK", align: center, text_font: font_small }}]
            on_click:
              then:
                - script.execute: register_activity
                - lvgl.page.show: main_page

        - button:
            id: btn_schedule8_toggle
            x: 20
            y: 70
            width: 260
            height: 60
            bg_color: 0x555555
            widgets:
              - label:
                  id: lbl_schedule8_state
                  align: center
                  text_font: font_small
                  text_color: 0xFFFFFF
                  text: "Timer: OFF"
            on_click:
              then:
                - script.execute: register_activity
                - lambda: |-
                    bool cur = id(plug8_schedule_enabled).state;
                    if (cur) {
                      id(plug8_schedule_enabled).turn_off();
                    } else {
                      id(plug8_schedule_enabled).turn_on();
                    }

        - label:
            id: lbl8_on_time
            x: 20
            y: 150
            text_font: font_small
            text_color: 0xFFFFFF
            text: "ON: 08:00 AM"

        - button:
            id: btn8_on_hour_minus
            x: 20
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug8_on_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug8_on_hour_persist) = h;
                    id(plug8_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl8_on_time
                    text: !lambda |-
                      int h = (int) id(plug8_on_hour).state;
                      int m = (int) id(plug8_on_minute).state;
                      auto ampm = id(plug8_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn8_on_hour_plus
            x: 110
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug8_on_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug8_on_hour_persist) = h;
                    id(plug8_on_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl8_on_time
                    text: !lambda |-
                      int h = (int) id(plug8_on_hour).state;
                      int m = (int) id(plug8_on_minute).state;
                      auto ampm = id(plug8_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn8_on_minute_minus
            x: 200
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug8_on_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug8_on_minute_persist) = m;
                    id(plug8_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl8_on_time
                    text: !lambda |-
                      int h = (int) id(plug8_on_hour).state;
                      int m = (int) id(plug8_on_minute).state;
                      auto ampm = id(plug8_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn8_on_minute_plus
            x: 290
            y: 190
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug8_on_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug8_on_minute_persist) = m;
                    id(plug8_on_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl8_on_time
                    text: !lambda |-
                      int h = (int) id(plug8_on_hour).state;
                      int m = (int) id(plug8_on_minute).state;
                      auto ampm = id(plug8_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn8_on_ampm
            x: 380
            y: 190
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl8_on_ampm
                  align: center
                  text_font: font_small
                  text: "AM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug8_on_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug8_on_ampm_persist) = new_val;
                    id(plug8_on_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl8_on_ampm
                    text: !lambda |-
                      return id(plug8_on_ampm).state;
                - lvgl.label.update:
                    id: lbl8_on_time
                    text: !lambda |-
                      int h = (int) id(plug8_on_hour).state;
                      int m = (int) id(plug8_on_minute).state;
                      auto ampm = id(plug8_on_ampm).state;
                      char buf[24];
                      sprintf(buf, "ON: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - label:
            id: lbl8_off_time
            x: 20
            y: 270
            text_font: font_small
            text_color: 0xFFFFFF
            text: "OFF: 06:00 PM"

        - button:
            id: btn8_off_hour_minus
            x: 20
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug8_off_hour).state;
                    h = (h <= 1) ? 12 : h - 1;
                    id(plug8_off_hour_persist) = h;
                    id(plug8_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl8_off_time
                    text: !lambda |-
                      int h = (int) id(plug8_off_hour).state;
                      int m = (int) id(plug8_off_minute).state;
                      auto ampm = id(plug8_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn8_off_hour_plus
            x: 110
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "H+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int h = (int) id(plug8_off_hour).state;
                    h = (h >= 12) ? 1 : h + 1;
                    id(plug8_off_hour_persist) = h;
                    id(plug8_off_hour).publish_state(h);
                - lvgl.label.update:
                    id: lbl8_off_time
                    text: !lambda |-
                      int h = (int) id(plug8_off_hour).state;
                      int m = (int) id(plug8_off_minute).state;
                      auto ampm = id(plug8_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn8_off_minute_minus
            x: 200
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M-", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug8_off_minute).state;
                    m = (m <= 0) ? 59 : m - 1;
                    id(plug8_off_minute_persist) = m;
                    id(plug8_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl8_off_time
                    text: !lambda |-
                      int h = (int) id(plug8_off_hour).state;
                      int m = (int) id(plug8_off_minute).state;
                      auto ampm = id(plug8_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn8_off_minute_plus
            x: 290
            y: 310
            width: 80
            height: 50
            bg_color: 0x444444
            widgets: [{ label: { text: "M+", align: center, text_font: font_small }}]
            on_click:
              then:
                - lambda: |-
                    int m = (int) id(plug8_off_minute).state;
                    m = (m >= 59) ? 0 : m + 1;
                    id(plug8_off_minute_persist) = m;
                    id(plug8_off_minute).publish_state(m);
                - lvgl.label.update:
                    id: lbl8_off_time
                    text: !lambda |-
                      int h = (int) id(plug8_off_hour).state;
                      int m = (int) id(plug8_off_minute).state;
                      auto ampm = id(plug8_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings

        - button:
            id: btn8_off_ampm
            x: 380
            y: 310
            width: 100
            height: 50
            bg_color: 0x444444
            widgets:
              - label:
                  id: lbl8_off_ampm
                  align: center
                  text_font: font_small
                  text: "PM"
            on_click:
              then:
                - lambda: |-
                    auto cur = id(plug8_off_ampm).state;
                    std::string new_val = cur == "AM" ? "PM" : "AM";
                    id(plug8_off_ampm_persist) = new_val;
                    id(plug8_off_ampm).publish_state(new_val);
                - lvgl.label.update:
                    id: lbl8_off_ampm
                    text: !lambda |-
                      return id(plug8_off_ampm).state;
                - lvgl.label.update:
                    id: lbl8_off_time
                    text: !lambda |-
                      int h = (int) id(plug8_off_hour).state;
                      int m = (int) id(plug8_off_minute).state;
                      auto ampm = id(plug8_off_ampm).state;
                      char buf[24];
                      sprintf(buf, "OFF: %02d:%02d %s", h, m, ampm.c_str());
                      return std::string(buf);
                - script.execute: save_timer_settings


    # PLUG INFO PAGE
    - id: plug_info_page
      widgets:
      - obj:
          id: info_bg
          x: 0
          y: 0
          width: 800
          height: 480
          bg_color: 0x101830

      - label:
          text: "Plug Information"
          align: top_mid
          y: 10
          text_font: font_large
          text_color: 0xFFFFFF

      - label:
          id: lbl_plug1_title
          text: "Plug 1:"
          x: 20
          y: 60
          text_font: font_small
          text_color: 0xFFFFFF

      - label:
          id: lbl_plug1_info
          text: "-"
          x: 120
          y: 60
          width: 640
          text_font: font_small
          text_color: 0xFFFFFF
          long_mode: dot

      - button:
          id: btn_info_refresh
          x: 200
          y: 340
          width: 150
          height: 45
          bg_color: 0x228B22
          widgets: [{ label: { text: "Refresh", align: center, text_font: font_small }}]
          on_click:
            then:
            - script.execute: fetch_all_plug_info

      - button:
          id: btn_info_back
          x: 380
          y: 340
          width: 150
          height: 45
          bg_color: 0x444444
          widgets: [{ label: { text: "Back", align: center, text_font: font_small }}]
          on_click:
            then:
            - lvgl.page.show: main_page

interval:
  - interval: 10s
    then:
      - script.execute: bl_auto_off_check

  # Rotating state check with smart failure tracking
  # Only checks enabled plugs with <3 consecutive failures to prevent lockups
  # Cycles through plugs 1-8
  - interval: 10s
    then:
      - if:
          condition:
            wifi.connected:
          then:
            - lambda: |-
                int plug = id(plug_check_counter);

                // Check if plug is enabled and hasn't failed too many times
                bool is_enabled = false;
                bool should_check = false;
                int failure_count = 0;

                if (plug == 0) { is_enabled = id(plug1_enabled); failure_count = id(plug1_failure_count); }
                else if (plug == 1) { is_enabled = id(plug2_enabled); failure_count = id(plug2_failure_count); }
                else if (plug == 2) { is_enabled = id(plug3_enabled); failure_count = id(plug3_failure_count); }
                else if (plug == 3) { is_enabled = id(plug4_enabled); failure_count = id(plug4_failure_count); }
                else if (plug == 4) { is_enabled = id(plug5_enabled); failure_count = 0; }
                else if (plug == 5) { is_enabled = id(plug6_enabled); failure_count = 0; }
                else if (plug == 6) { is_enabled = id(plug7_enabled); failure_count = 0; }
                else if (plug == 7) { is_enabled = id(plug8_enabled); failure_count = 0; }

                should_check = is_enabled && (failure_count < 3);

                if (should_check) {
                  ESP_LOGD("STATE", "Checking plug %d state", plug + 1);
                  if (plug == 0) id(plug1_update_state).execute();
                  else if (plug == 1) id(plug2_update_state).execute();
                  else if (plug == 2) id(plug3_update_state).execute();
                  else if (plug == 3) id(plug4_update_state).execute();
                  else if (plug == 4) id(plug5_update_state).execute();
                  else if (plug == 5) id(plug6_update_state).execute();
                  else if (plug == 6) id(plug7_update_state).execute();
                  else if (plug == 7) id(plug8_update_state).execute();
                } else if (!is_enabled) {
                  ESP_LOGD("STATE", "Skipping plug %d (disabled)", plug + 1);
                } else {
                  ESP_LOGD("STATE", "Skipping plug %d (too many failures: %d)", plug + 1, failure_count);
                }

                // Increment counter and wrap around 0-7
                id(plug_check_counter) = (plug + 1) % 8;

  # Clock update
  - interval: 10s
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          char buf[16];
          int h12 = now.hour % 12;
          if (h12 == 0) h12 = 12;
          bool pm = now.hour >= 12;
          sprintf(buf, "%02d:%02d %s", h12, now.minute, pm ? "PM" : "AM");
          lv_label_set_text(id(lbl_main_time), buf);
          lv_label_set_text(id(lbl_timer1_clock), buf);
          lv_label_set_text(id(lbl_timer2_clock), buf);
          lv_label_set_text(id(lbl_timer3_clock), buf);
          lv_label_set_text(id(lbl_timer4_clock), buf);
          lv_label_set_text(id(lbl_timer5_clock), buf);
          lv_label_set_text(id(lbl_timer6_clock), buf);
          lv_label_set_text(id(lbl_timer7_clock), buf);
          lv_label_set_text(id(lbl_timer8_clock), buf);

  # Reset failure counters every 5 minutes to retry previously failed plugs
  - interval: 5min
    then:
      - lambda: |-
          ESP_LOGD("STATE", "Resetting failure counters (retry failed plugs)");
          id(plug1_failure_count) = 0;
          id(plug2_failure_count) = 0;
          id(plug3_failure_count) = 0;
          id(plug4_failure_count) = 0;

  # Animated background gradient - cycles through professional color palette
  - interval: 3s
    then:
      - lambda: |-
          // Color palette: Deep blues, purples, and teals for professional look
          const uint32_t colors[] = {
            0x0A1929,  // Deep navy
            0x0D1B2A,  // Dark blue
            0x1B263B,  // Slate blue
            0x132A3A,  // Deep teal
            0x1A1F3A,  // Dark purple-blue
            0x0F1E2E   // Midnight blue
          };

          int step = id(bg_animation_step) % 6;
          lv_obj_set_style_bg_color(id(main_bg), lv_color_hex(colors[step]), LV_PART_MAIN);

          id(bg_animation_step) = step + 1;

  # Schedule logic for plug 1
  - interval: 1min
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          if (!id(plug1_schedule_enabled).state) return;
          int cur_minutes = now.hour * 60 + now.minute;

          int on_h12 = (int) id(plug1_on_hour).state;
          int on_m   = (int) id(plug1_on_minute).state;
          auto on_ampm = id(plug1_on_ampm).state;
          bool on_pm = (on_ampm == "PM");
          int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
          int on_minutes = on_h24 * 60 + on_m;

          int off_h12 = (int) id(plug1_off_hour).state;
          int off_m   = (int) id(plug1_off_minute).state;
          auto off_ampm = id(plug1_off_ampm).state;
          bool off_pm = (off_ampm == "PM");
          int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
          int off_minutes = off_h24 * 60 + off_m;

          // Handle schedules that cross midnight
          bool should_on;
          if (on_minutes < off_minutes) {
            // Normal case: 8 AM to 6 PM
            should_on = (cur_minutes >= on_minutes) && (cur_minutes < off_minutes);
          } else {
            // Crosses midnight: 6 PM to 8 AM
            should_on = (cur_minutes >= on_minutes) || (cur_minutes < off_minutes);
          }

          static bool last_on1 = false;
          static bool first_run1 = true;

          // On first run, sync with actual plug state
          if (first_run1) {
            first_run1 = false;
            last_on1 = id(plug1_ui_state);
          }

          if (should_on != last_on1) {
            last_on1 = should_on;
            if (should_on) id(plug1_turn_on).execute();
            else           id(plug1_turn_off).execute();
          }


  # Schedule logic for plug 2
  - interval: 1min
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          if (!id(plug2_schedule_enabled).state) return;
          int cur_minutes = now.hour * 60 + now.minute;

          int on_h12 = (int) id(plug2_on_hour).state;
          int on_m   = (int) id(plug2_on_minute).state;
          auto on_ampm = id(plug2_on_ampm).state;
          bool on_pm = (on_ampm == "PM");
          int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
          int on_minutes = on_h24 * 60 + on_m;

          int off_h12 = (int) id(plug2_off_hour).state;
          int off_m   = (int) id(plug2_off_minute).state;
          auto off_ampm = id(plug2_off_ampm).state;
          bool off_pm = (off_ampm == "PM");
          int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
          int off_minutes = off_h24 * 60 + off_m;

          bool should_on;
          if (on_minutes < off_minutes) {
            should_on = (cur_minutes >= on_minutes) && (cur_minutes < off_minutes);
          } else {
            should_on = (cur_minutes >= on_minutes) || (cur_minutes < off_minutes);
          }

          static bool last_on2 = false;
          static bool first_run2 = true;
          if (first_run2) {
            first_run2 = false;
            last_on2 = id(plug2_ui_state);
          }

          if (should_on != last_on2) {
            last_on2 = should_on;
            if (should_on) id(plug2_turn_on).execute();
            else           id(plug2_turn_off).execute();
          }

  # Schedule logic for plug 3
  - interval: 1min
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          if (!id(plug3_schedule_enabled).state) return;
          int cur_minutes = now.hour * 60 + now.minute;

          int on_h12 = (int) id(plug3_on_hour).state;
          int on_m   = (int) id(plug3_on_minute).state;
          auto on_ampm = id(plug3_on_ampm).state;
          bool on_pm = (on_ampm == "PM");
          int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
          int on_minutes = on_h24 * 60 + on_m;

          int off_h12 = (int) id(plug3_off_hour).state;
          int off_m   = (int) id(plug3_off_minute).state;
          auto off_ampm = id(plug3_off_ampm).state;
          bool off_pm = (off_ampm == "PM");
          int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
          int off_minutes = off_h24 * 60 + off_m;

          bool should_on;
          if (on_minutes < off_minutes) {
            should_on = (cur_minutes >= on_minutes) && (cur_minutes < off_minutes);
          } else {
            should_on = (cur_minutes >= on_minutes) || (cur_minutes < off_minutes);
          }

          static bool last_on3 = false;
          static bool first_run3 = true;
          if (first_run3) {
            first_run3 = false;
            last_on3 = id(plug3_ui_state);
          }

          if (should_on != last_on3) {
            last_on3 = should_on;
            if (should_on) id(plug3_turn_on).execute();
            else           id(plug3_turn_off).execute();
          }

  # Schedule logic for plug 4
  - interval: 1min
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          if (!id(plug4_schedule_enabled).state) return;
          int cur_minutes = now.hour * 60 + now.minute;

          int on_h12 = (int) id(plug4_on_hour).state;
          int on_m   = (int) id(plug4_on_minute).state;
          auto on_ampm = id(plug4_on_ampm).state;
          bool on_pm = (on_ampm == "PM");
          int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
          int on_minutes = on_h24 * 60 + on_m;

          int off_h12 = (int) id(plug4_off_hour).state;
          int off_m   = (int) id(plug4_off_minute).state;
          auto off_ampm = id(plug4_off_ampm).state;
          bool off_pm = (off_ampm == "PM");
          int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
          int off_minutes = off_h24 * 60 + off_m;

          bool should_on;
          if (on_minutes < off_minutes) {
            should_on = (cur_minutes >= on_minutes) && (cur_minutes < off_minutes);
          } else {
            should_on = (cur_minutes >= on_minutes) || (cur_minutes < off_minutes);
          }

          static bool last_on4 = false;
          static bool first_run4 = true;
          if (first_run4) {
            first_run4 = false;
            last_on4 = id(plug4_ui_state);
          }

          if (should_on != last_on4) {
            last_on4 = should_on;
            if (should_on) id(plug4_turn_on).execute();
            else           id(plug4_turn_off).execute();
          }

  # Schedule logic for plug 5
  - interval: 1min
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          if (!id(plug5_schedule_enabled).state) return;
          int cur_minutes = now.hour * 60 + now.minute;

          int on_h12 = (int) id(plug5_on_hour).state;
          int on_m   = (int) id(plug5_on_minute).state;
          auto on_ampm = id(plug5_on_ampm).state;
          bool on_pm = (on_ampm == "PM");
          int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
          int on_minutes = on_h24 * 60 + on_m;

          int off_h12 = (int) id(plug5_off_hour).state;
          int off_m   = (int) id(plug5_off_minute).state;
          auto off_ampm = id(plug5_off_ampm).state;
          bool off_pm = (off_ampm == "PM");
          int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
          int off_minutes = off_h24 * 60 + off_m;

          bool should_on;
          if (on_minutes < off_minutes) {
            should_on = (cur_minutes >= on_minutes) && (cur_minutes < off_minutes);
          } else {
            should_on = (cur_minutes >= on_minutes) || (cur_minutes < off_minutes);
          }

          static bool last_on5 = false;
          static bool first_run5 = true;
          if (first_run5) {
            first_run5 = false;
            last_on5 = id(plug5_ui_state);
          }

          if (should_on != last_on5) {
            last_on5 = should_on;
            if (should_on) id(plug5_turn_on).execute();
            else           id(plug5_turn_off).execute();
          }

  # Schedule logic for plug 6
  - interval: 1min
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          if (!id(plug6_schedule_enabled).state) return;
          int cur_minutes = now.hour * 60 + now.minute;

          int on_h12 = (int) id(plug6_on_hour).state;
          int on_m   = (int) id(plug6_on_minute).state;
          auto on_ampm = id(plug6_on_ampm).state;
          bool on_pm = (on_ampm == "PM");
          int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
          int on_minutes = on_h24 * 60 + on_m;

          int off_h12 = (int) id(plug6_off_hour).state;
          int off_m   = (int) id(plug6_off_minute).state;
          auto off_ampm = id(plug6_off_ampm).state;
          bool off_pm = (off_ampm == "PM");
          int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
          int off_minutes = off_h24 * 60 + off_m;

          bool should_on;
          if (on_minutes < off_minutes) {
            should_on = (cur_minutes >= on_minutes) && (cur_minutes < off_minutes);
          } else {
            should_on = (cur_minutes >= on_minutes) || (cur_minutes < off_minutes);
          }

          static bool last_on6 = false;
          static bool first_run6 = true;
          if (first_run6) {
            first_run6 = false;
            last_on6 = id(plug6_ui_state);
          }

          if (should_on != last_on6) {
            last_on6 = should_on;
            if (should_on) id(plug6_turn_on).execute();
            else           id(plug6_turn_off).execute();
          }

  # Schedule logic for plug 7
  - interval: 1min
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          if (!id(plug7_schedule_enabled).state) return;
          int cur_minutes = now.hour * 60 + now.minute;

          int on_h12 = (int) id(plug7_on_hour).state;
          int on_m   = (int) id(plug7_on_minute).state;
          auto on_ampm = id(plug7_on_ampm).state;
          bool on_pm = (on_ampm == "PM");
          int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
          int on_minutes = on_h24 * 60 + on_m;

          int off_h12 = (int) id(plug7_off_hour).state;
          int off_m   = (int) id(plug7_off_minute).state;
          auto off_ampm = id(plug7_off_ampm).state;
          bool off_pm = (off_ampm == "PM");
          int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
          int off_minutes = off_h24 * 60 + off_m;

          bool should_on;
          if (on_minutes < off_minutes) {
            should_on = (cur_minutes >= on_minutes) && (cur_minutes < off_minutes);
          } else {
            should_on = (cur_minutes >= on_minutes) || (cur_minutes < off_minutes);
          }

          static bool last_on7 = false;
          static bool first_run7 = true;
          if (first_run7) {
            first_run7 = false;
            last_on7 = id(plug7_ui_state);
          }

          if (should_on != last_on7) {
            last_on7 = should_on;
            if (should_on) id(plug7_turn_on).execute();
            else           id(plug7_turn_off).execute();
          }

  # Schedule logic for plug 8
  - interval: 1min
    then:
      - lambda: |-
          auto now = id(sntp_time).now();
          if (!now.is_valid()) return;
          if (!id(plug8_schedule_enabled).state) return;
          int cur_minutes = now.hour * 60 + now.minute;

          int on_h12 = (int) id(plug8_on_hour).state;
          int on_m   = (int) id(plug8_on_minute).state;
          auto on_ampm = id(plug8_on_ampm).state;
          bool on_pm = (on_ampm == "PM");
          int on_h24 = (on_h12 % 12) + (on_pm ? 12 : 0);
          int on_minutes = on_h24 * 60 + on_m;

          int off_h12 = (int) id(plug8_off_hour).state;
          int off_m   = (int) id(plug8_off_minute).state;
          auto off_ampm = id(plug8_off_ampm).state;
          bool off_pm = (off_ampm == "PM");
          int off_h24 = (off_h12 % 12) + (off_pm ? 12 : 0);
          int off_minutes = off_h24 * 60 + off_m;

          bool should_on;
          if (on_minutes < off_minutes) {
            should_on = (cur_minutes >= on_minutes) && (cur_minutes < off_minutes);
          } else {
            should_on = (cur_minutes >= on_minutes) || (cur_minutes < off_minutes);
          }

          static bool last_on8 = false;
          static bool first_run8 = true;
          if (first_run8) {
            first_run8 = false;
            last_on8 = id(plug8_ui_state);
          }

          if (should_on != last_on8) {
            last_on8 = should_on;
            if (should_on) id(plug8_turn_on).execute();
            else           id(plug8_turn_off).execute();
          }